# attlib_parsing_logic.md éªŒè¯æŠ¥å‘Š

åŸºäº IDA Pro åç¼–è¯‘çš„ core.dll ä¸‰ä¸ªå…³é”®å‡½æ•°ï¼Œå¯¹æ–‡æ¡£ä¸­çš„è§£æé€»è¾‘è¿›è¡Œé€é¡¹éªŒè¯ã€‚

---

## âœ… éªŒè¯ç»“æœæ€»ç»“

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| FHDBRN åˆ†é¡µæœºåˆ¶ | âœ… æ­£ç¡® | 0x00000000 è¡¨ç¤ºé¡µåˆ‡æ¢ï¼Œ0xFFFFFFFF è¡¨ç¤ºæ®µç»“æŸ |
| ATGTIX ä¸‰å…ƒç»„å­˜å‚¨ | âŒ **é”™è¯¯** | æ–‡æ¡£è¯´æ³•æœ‰è¯¯ï¼Œå®é™…æ˜¯åˆ†åˆ«å­˜å‚¨çš„ä¸‰ä¸ªç‹¬ç«‹å­— |
| ATGTDF é»˜è®¤å€¼è§£æ | âœ… æ­£ç¡® | TEXT ç±»å‹å…ˆè¯»é•¿åº¦å†è¯»æ•°æ®ï¼Œæ ‡é‡ç±»å‹ç›´æ¥è¯»ä¸€ä¸ªå­— |
| å“ˆå¸Œå€¼èŒƒå›´æ£€æŸ¥ | âœ… æ­£ç¡® | 531442 - 387951929 çš„èŒƒå›´æ£€æŸ¥é€»è¾‘æ­£ç¡® |
| é¡µå†…åç§»å•ä½ | âœ… æ­£ç¡® | ä»¥ 32 ä½å­—ä¸ºå•ä½ï¼ŒèŒƒå›´ 0-511 |

---

## ğŸ”´ å…³é”®é”™è¯¯è¯¦è§£

### é”™è¯¯ 1ï¼šATGTIX ä¸‰å…ƒç»„è§£æé€»è¾‘ï¼ˆç¬¬ 3.3 èŠ‚ã€ç¬¬ 4.1 èŠ‚ï¼‰

**æ–‡æ¡£é”™è¯¯ä»£ç **ï¼ˆç¬¬ 3.3 èŠ‚ç¬¬ 110-111 è¡Œï¼‰ï¼š
```c
record_num = buffer[++index] / 512;    // è®°å½•å·
slot_offset = buffer[++index] % 512;   // é¡µå†…åç§»
```

**IDA Pro åç¼–è¯‘å®é™…ä»£ç **ï¼ˆ`sub_10852A64` ç¬¬ 42-45 è¡Œï¼‰ï¼š
```c
v16 = var80C[v14++];                           // ç¬¬äºŒä¸ªå­—
*(_DWORD *)(a4 + 4 * *a7 - 4) = v16 / 512;    // record_num = v16 / 512
*(_DWORD *)(a5 + 4 * *a7 - 4) = v16 % 512;    // slot_offset = v16 % 512
```

**æ±‡ç¼–éªŒè¯**ï¼ˆ0x10852bf6-0x10852c49ï¼‰ï¼š
```assembly
0x10852bf6: mov [ebp+var_818], eax        // v16 = var80C[v14++]
0x10852c02: sar eax, 8                    // ç®—æœ¯å³ç§» 8 ä½
0x10852c05: shr eax, 17h                  // é€»è¾‘å³ç§» 23 ä½ï¼ˆå…± 31 ä½ï¼‰
0x10852c08: add eax, [ebp+var_818]        // åŠ ä¸ŠåŸå€¼ï¼ˆé™¤ä»¥ 512 çš„ä¼˜åŒ–ï¼‰
0x10852c0e: sar eax, 9                    // ç®—æœ¯å³ç§» 9 ä½ â†’ record_num
0x10852c1f: mov [edx], eax                // å­˜å‚¨ record_num
0x10852c32: cdq                           // ç¬¦å·æ‰©å±•
0x10852c39: idiv , ecx                    // é™¤ä»¥ 512 â†’ slot_offset
0x10852c49: mov [eax], edx                // å­˜å‚¨ slot_offset (ä½™æ•°)
```

**é—®é¢˜åˆ†æ**ï¼š
- æ–‡æ¡£è¯´"ç¬¬äºŒä¸ªå­—å’Œç¬¬ä¸‰ä¸ªå­—åˆ†åˆ«å­˜å‚¨"ï¼Œä½†å®é™…ä¸Š**åªæœ‰ä¸€ä¸ªå­— `v16`**
- `record_num` å’Œ `slot_offset` éƒ½æ˜¯ä»**åŒä¸€ä¸ªå­— `v16`** ä¸­æå–çš„
- `record_num = v16 / 512`ï¼ˆå•†ï¼‰
- `slot_offset = v16 % 512`ï¼ˆä½™æ•°ï¼‰

**æ­£ç¡®ç†è§£**ï¼š
```
ATGTIX ä¸‰å…ƒç»„å®é™…ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å­— 0: attr_hash (32 ä½)                  â”‚
â”‚ å­— 1: combined (32 ä½)                   â”‚
â”‚       â”œâ”€ record_num = combined / 512     â”‚
â”‚       â””â”€ slot_offset = combined % 512    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¿®æ­£å»ºè®®**ï¼š
```c
// æ­£ç¡®çš„ä¸‰å…ƒç»„ç»“æ„
typedef struct {
    uint32_t attr_hash;     // ç¬¬ä¸€ä¸ªå­—
    uint32_t combined;      // ç¬¬äºŒä¸ªå­—ï¼ˆåŒ…å« record_num å’Œ slot_offsetï¼‰
} AttlibAttrIndex;

// è§£ææ—¶
record_num = combined / 512;    // å•†
slot_offset = combined % 512;   // ä½™æ•°
```

---

## âœ… éªŒè¯é€šè¿‡çš„é€»è¾‘

### 1. FHDBRN åˆ†é¡µæœºåˆ¶ï¼ˆç¬¬ 3.2 èŠ‚ï¼‰

**æ–‡æ¡£æè¿°**ï¼š
```
if word == 0x00000000:               // é¡µåˆ‡æ¢
    page += 1
    break                            // é‡æ–°è¯»å–ä¸‹ä¸€é¡µ
if word == 0xFFFFFFFF:               // æ®µç»ˆæ­¢
    return collected
```

**IDA Pro éªŒè¯**ï¼ˆ`sub_10852A64` ç¬¬ 47-51 è¡Œï¼‰ï¼š
```c
if ( !v15 )                    // v15 == 0
{
    ++v12;                     // page_num++
    continue;                  // ç»§ç»­è¯»å–ä¸‹ä¸€é¡µ
}
if ( v15 != -1 )               // v15 != 0xFFFFFFFF
{
    // é”™è¯¯å¤„ç†
    goto LABEL_20;
}
```

âœ… **å®Œå…¨æ­£ç¡®**

### 2. ATGTDF é»˜è®¤å€¼è§£æï¼ˆç¬¬ 5.3 èŠ‚ï¼‰

**æ–‡æ¡£æè¿°**ï¼š
- `default_flag == 1`ï¼šæ— é»˜è®¤å€¼
- `default_flag == 2` ä¸” `data_type == 4`ï¼šTEXT ç±»å‹ï¼Œå…ˆè¯»é•¿åº¦å†è¯»æ•°æ®
- `default_flag == 2` ä¸” `data_type âˆˆ {1,2,3}`ï¼šæ ‡é‡ç±»å‹ï¼Œè¯»ä¸€ä¸ªå­—

**IDA Pro éªŒè¯**ï¼ˆ`sub_10852E20` ç¬¬ 59-100 è¡Œï¼‰ï¼š
```c
if ( v20 == 1 )                        // default_flag == 1
{
    *(_DWORD *)(a5 + 4 * *a8 - 4) = 0;  // æ— é»˜è®¤å€¼
}
else if ( v20 == 2 )                   // default_flag == 2
{
    if ( v19 == 4 )                    // data_type == 4 (TEXT)
    {
        v21 = var80C[v17++];           // è¯»å–é•¿åº¦
        *(_DWORD *)(a6 + 4 * *a10 - 4) = v21;  // å­˜å‚¨é•¿åº¦
        // å¾ªç¯è¯»å– v21 ä¸ªå­—
        for (i = 1; i <= v21; i++)
        {
            ++v17;
            ++*a10;
            *(_DWORD *)(a6 + 4 * *a10 - 4) = var80C[v17 - 1];
        }
    }
    else                               // æ ‡é‡ç±»å‹
    {
        *(_DWORD *)(a6 + 4 * *a10 - 4) = var80C[v17++];  // è¯»ä¸€ä¸ªå­—
    }
}
```

**å…³é”®å‘ç°**ï¼š
- `a5` ç¼“å†²åŒºå­˜å‚¨"é»˜è®¤å€¼æŒ‡é’ˆ"ï¼ˆæŒ‡å‘ `a6` ä¸­çš„ç´¢å¼•ï¼‰
- `a6` ç¼“å†²åŒºå­˜å‚¨"å®é™…é»˜è®¤å€¼æ•°æ®"
- TEXT ç±»å‹ï¼šå…ˆå­˜å‚¨é•¿åº¦ï¼Œå†å­˜å‚¨ `length` ä¸ªå­—çš„æ•°æ®
- æ ‡é‡ç±»å‹ï¼šç›´æ¥å­˜å‚¨ä¸€ä¸ªå­—

âœ… **å®Œå…¨æ­£ç¡®**

### 3. å“ˆå¸Œå€¼èŒƒå›´æ£€æŸ¥ï¼ˆç¬¬ 4.2 èŠ‚ï¼‰

**æ–‡æ¡£å€¼**ï¼š531442 - 387951929

**IDA Pro éªŒè¯**ï¼ˆ`sub_10852A64` ç¬¬ 21-22 è¡Œï¼‰ï¼š
```c
v10 = 531442;           // æœ€å°å€¼
v11 = 387951929;        // æœ€å¤§å€¼
```

âœ… **å®Œå…¨æ­£ç¡®**

---

## ğŸ“ å»ºè®®ä¿®æ­£

### ä¿®æ­£ 1ï¼šç¬¬ 3.3 èŠ‚ä»£ç å—

**å½“å‰**ï¼š
```c
record_num = buffer[++index] / 512;
slot_offset = buffer[++index] % 512;
```

**ä¿®æ­£ä¸º**ï¼š
```c
uint32_t combined = buffer[++index];
record_num = combined / 512;
slot_offset = combined % 512;
```

### ä¿®æ­£ 2ï¼šç¬¬ 4.1 èŠ‚è¡¨æ ¼

**å½“å‰**ï¼š
| é¡ºåº | å­—æ®µ | å«ä¹‰ |
| 0 | `attr_hash` | å±æ€§å“ˆå¸Œå€¼ |
| 1 | `record_num` | å±æ€§å®šä¹‰æ‰€åœ¨çš„é¡µå· |
| 2 | `slot_offset` | é¡µå†…åç§» |

**ä¿®æ­£ä¸º**ï¼š
| é¡ºåº | å­—æ®µ | å«ä¹‰ |
| 0 | `attr_hash` | å±æ€§å“ˆå¸Œå€¼ |
| 1 | `combined` | åŒ…å« record_num å’Œ slot_offset çš„ç»„åˆå­— |

å…¶ä¸­ `combined` çš„ç»“æ„ä¸ºï¼š
- `record_num = combined / 512`ï¼ˆé«˜ä½ï¼‰
- `slot_offset = combined % 512`ï¼ˆä½ä½ï¼‰

### ä¿®æ­£ 3ï¼šç¬¬ 12.2 èŠ‚ä¼ªä»£ç 

**å½“å‰**ï¼ˆç¬¬ 634-636 è¡Œï¼‰ï¼š
```rust
let def_hash = words[cursor];
let data_type = words[cursor + 1];
let default_flag = words[cursor + 2];
```

**ä¿®æ­£ä¸º**ï¼š
```rust
let def_hash = words[cursor];
let combined = words[cursor + 1];
let record_num = combined / 512;
let slot_offset = combined % 512;
let data_type = words[cursor + 2];
let default_flag = words[cursor + 3];
```

---

## æ€»ç»“

æ–‡æ¡£æ•´ä½“ç»“æ„å’Œå¤§éƒ¨åˆ†é€»è¾‘**æ­£ç¡®**ï¼Œä½†åœ¨ ATGTIX ä¸‰å…ƒç»„çš„å­˜å‚¨æ ¼å¼ä¸Šæœ‰**å…³é”®é”™è¯¯**ã€‚

å®é™…æ ¼å¼æ˜¯ï¼š**ä¸¤ä¸ªå­—**ï¼ˆä¸æ˜¯ä¸‰ä¸ªå­—ï¼‰
- ç¬¬ä¸€ä¸ªå­—ï¼š`attr_hash`
- ç¬¬äºŒä¸ªå­—ï¼š`combined = (record_num << 9) | slot_offset`

éœ€è¦ç«‹å³ä¿®æ­£ç¬¬ 3.3ã€4.1ã€12.2 èŠ‚çš„ç›¸å…³ä»£ç ã€‚

