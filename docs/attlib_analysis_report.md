# attlib.dat 解析分析报告

## 执行摘要

通过 Python 脚本对 `data/attlib.dat` 进行了详细分析，发现该文件的结构与文档描述存在重大差异。

## 关键发现

### 1. 文件结构不完整

**预期结构**（根据文档）：
```
0x0000-0x07FF: UTF-16LE 头部
0x0800-0x081F: 段指针表（8 个 32 位指针）
0x1000+:       数据区
  ├─ ATGTIX 段（属性索引表）
  ├─ ATGTDF 段（属性定义表）
  └─ 其他段
```

**实际结构**（根据解析结果）：
```
0x0000-0x07FF: UTF-16LE 头部
0x0800-0x081F: 段指针表（8 个 32 位指针）
0x1000+:       数据区
  ├─ ATGTIX 段（属性索引表）✓ 找到 15 条记录
  └─ ATGTDF 段（属性定义表）✗ 找不到（0 条记录）
```

### 2. 段指针表

```
段 0: 0x00000003 (页号: 3)
段 1: 0x00000004 (页号: 4)
段 2: 0x00000693 (页号: 1683)
段 3: 0x000006A8 (页号: 1704)
段 4: 0x000006CD (页号: 1741)
段 5: 0x000006CE (页号: 1742)
段 6: 0x000008BC (页号: 2236)
段 7: 0x000008C2 (页号: 2242)
```

**问题**：
- 段指针 [0] 和 [1] 指向的页面（3 和 4）中没有有效的属性定义
- 页 0 中找到了 ATGTIX 段，但不是通过段指针定位的

### 3. ATGTIX 段（属性索引表）

**位置**：页 0（0x1000）开始

**找到的 15 条属性**：
```
[0]  hash=0x0009E770 (649072),   combined=0x00000003
[1]  hash=0x000D3372 (865138),   combined=0x00000003
[2]  hash=0x0034482B (3426347),  combined=0x00000001
[3]  hash=0x0C6A3EBC (208289468),combined=0x00000003
[4]  hash=0x0C68B22C (208187948),combined=0x00000003
[5]  hash=0x01E129B2 (31533490), combined=0x00000008
[6]  hash=0x0009C18E (639374),   combined=0x00000004  ← NAME
[7]  hash=0x000F8BEF (1018863),  combined=0x00000004
[8]  hash=0x14BD9A10 (347970064),combined=0x00000004
[9]  hash=0x0009CCA7 (642215),   combined=0x00000003  ← TYPE
[10] hash=0x112EF91A (288291098),combined=0x00000001
[11] hash=0x000E6432 (943154),   combined=0x00000004
[12] hash=0x000AE18D (713101),   combined=0x00000003
[13] hash=0x000BBBB6 (768950),   combined=0x00000008
[14] hash=0x000C40C4 (803012),   combined=0x00000003
```

### 4. ATGTDF 段（属性定义表）

**状态**：未找到

**尝试的位置**：
- 页 0 之后（ATGTIX 段结束后）：0 条记录
- 段指针 [1] 指向的页 4：0 条记录

### 5. ELBO 属性对比

**ELBO.json 中的属性**：55 个

**在 attlib.dat 中找到的**：2 个
- ✓ NAME (hash: 639374) - 在 ATGTIX 中找到
- ✓ TYPE (hash: 642215) - 在 ATGTIX 中找到

**未找到的**：53 个
- ✗ POS (hash: 545713)
- ✗ ORI (hash: 538503)
- ✗ RLIN (hash: 813906)
- ... 等等

## 结论

1. **attlib.dat 是一个不完整或特殊格式的属性库文件**
   - 只包含 ATGTIX 段（属性索引），没有 ATGTDF 段（属性定义）
   - 段指针表可能指向其他类型的数据，不是属性定义

2. **ELBO.json 中的数据不来自 attlib.dat**
   - 大部分 ELBO 属性在 attlib.dat 中找不到
   - 这些数据可能来自 E3D 的运行时数据库或其他配置文件

3. **combined 字段的用途不明**
   - 文档说它应该分解为 record_num 和 slot_offset 来定位 ATGTDF
   - 但由于 ATGTDF 不存在，这个字段的实际用途需要进一步调查

## 深入分析

### 段指针的实际含义

根据 IDA Pro 反编译代码（`sub_10851210` 第 96 行）：
```c
v47[i - 1] = dword_11C2A860[512 * v22 - 513 + i];
```

这说明段指针表中的 8 个值是从某个缓冲区中读取的。这些值被传递给：
- `sub_10852A64`（Attlib_LoadAttrIndex）- 处理 ATGTIX 段
- `sub_10852E20`（Attlib_LoadAttrDefinitions）- 处理 ATGTDF 段

**调用顺序**（根据 IDA Pro 代码）：
1. 第 98 行：`sub_10852A64(..., v47[2], ...)`  - 加载 ATGTIX
2. 第 109 行：`sub_10852E20(..., v47[0], ...)`  - 加载 ATGTDF
3. 第 127 行：`sub_10852A64(..., v47[6], ...)`  - 加载另一个 ATGTIX
4. 第 138 行：`sub_10852E20(..., v47[4], ...)`  - 加载另一个 ATGTDF

### 当前 data/attlib.dat 的问题

1. **段指针表的值**：[3, 4, 1683, 1704, 1741, 1742, 2236, 2242]
2. **页 3 和 4 的内容**：都是文本数据，不是属性定义
3. **页 0 的内容**：包含 ATGTIX 段（15 条属性索引）

### 可能的解释

1. **data/attlib.dat 是一个不完整的文件**
   - 可能只包含 ATGTIX 段，没有 ATGTDF 段
   - 段指针表可能指向其他类型的数据（如文本或其他元数据）

2. **段指针表的含义可能不同**
   - 可能不是指向 ATGTIX/ATGTDF 段的指针
   - 可能是指向其他数据结构的指针

3. **ELBO.json 中的数据来自其他来源**
   - 不是来自 attlib.dat
   - 可能来自 E3D 的运行时数据库或其他配置文件

## 建议

1. **获取完整的 attlib.dat 文件**
   - 当前文件可能是不完整的或特殊格式的
   - 需要从 E3D 的安装目录中获取完整的属性库文件

2. **分析 ELBO.json 的来源**
   - 检查 E3D 的数据库结构
   - 查看是否有其他文件存储了 ELBO 属性的定义

3. **验证段指针的含义**
   - 使用 IDA Pro 跟踪 `sub_10852A64` 和 `sub_10852E20` 的实际行为
   - 确认段指针是否真的指向 ATGTIX/ATGTDF 段

4. **检查 combined 字段的用途**
   - 当前的 combined 值都很小（0-8）
   - 可能不是用来定位 ATGTDF 的
   - 可能有其他含义（如属性类型、标志等）

