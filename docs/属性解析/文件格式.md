# attlib.dat 文件格式详解

## 文件结构概览

```text
偏移量        大小      内容
─────────────────────────────────────────
0x0000       2048B     文件头区域
0x0800       32B       段指针表 (8 × u32)
0x0820       1984B     保留区域
0x1000       ...       数据记录区域 (分页存储)
```

## 字节序

所有 32 位整数使用 **大端序（Big-Endian）** 存储。

## 段指针表 (0x0800)

```text
偏移     字段           说明
────────────────────────────────────
0x800    ptr[0]        ATGTDF-1 起始页号
0x804    ptr[1]        保留
0x808    ptr[2]        ATGTIX-1 起始页号
0x80C    ptr[3]        ATGTSX 起始页号
0x810    ptr[4]        ATGTDF-2 起始页号
0x814    ptr[5]        保留
0x818    ptr[6]        ATGTIX-2 起始页号
0x81C    ptr[7]        保留
```

## 分页机制

### 页面布局

- **页面大小**：2048 字节 = 512 个 32 位字
- **数据区起始**：0x1000 (第 0 页)
- **页面偏移计算**：`file_offset = 0x1000 + page_num × 2048`

### 特殊标记

| 值 | 含义 |
|----|------|
| `0x00000000` | 页切换标记，跳转到下一页 |
| `0xFFFFFFFF` | 段结束标记，停止读取 |

## ATGTIX 索引段格式

属性索引表，存储属性哈希到位置的映射。

### 记录结构

```text
字段         大小    说明
─────────────────────────────────
attr_hash    4B      属性哈希值 (27进制编码)
combined     4B      组合位置信息
```

### combined 字段解码

```rust
record_num = combined / 512;   // 记录所在页号
slot_offset = combined % 512;  // 页内字偏移
```

### 有效性检查

```rust
MIN_HASH = 531442;      // 0x81BF2
MAX_HASH = 387951929;   // 0x171FAD39

// 有效哈希范围检查
if hash >= MIN_HASH && hash <= MAX_HASH {
    // 有效的属性哈希
}
```

## ATGTDF 定义段格式

属性定义表，存储属性的类型和默认值。

### 基本结构

```text
字段           大小    说明
─────────────────────────────────────
attr_hash      4B      属性哈希值
data_type      4B      数据类型 (1-4)
default_flag   4B      默认值标志
[default_val]  变长    默认值数据（可选）
```

### 数据类型编码

| 值 | 类型 | 默认值大小 |
|----|------|-----------|
| 1 | LOG (布尔) | 4 字节 |
| 2 | REAL (浮点) | 4 字节 |
| 3 | INT (整数) | 4 字节 |
| 4 | TEXT (文本) | 变长 |

### 默认值标志

| 值 | 含义 |
|----|------|
| 1 | 无默认值 |
| 2 | 有默认值 |

### TEXT 类型默认值格式

```text
字段         大小    说明
─────────────────────────────────
length       4B      文本长度（字数）
data[0]      4B      27进制编码字 1
data[1]      4B      27进制编码字 2
...          ...     ...
data[n-1]    4B      27进制编码字 n
```

## PDMS 哈希编码

PDMS 使用两种哈希编码方式，基于 `db_tool.rs` 中的 `db1_dehash_uncached` 函数。

### 哈希范围常量

```rust
const HASH_BASE_OFFSET: u32 = 0x81BF1;      // 531441 - 基础偏移量
const HASH_UDA_THRESHOLD: u32 = 0x171FAD39; // 387951929 - UDA 属性阈值
```

### 哈希类型判断

| 范围 | 类型 | 编码方式 |
|------|------|----------|
| hash ≤ 0x81BF1 | 无效 | - |
| 0x81BF2 ≤ hash ≤ 0x171FAD39 | 普通属性 | 27 进制 |
| hash > 0x171FAD39 | UDA 属性 | 64 进制，前缀 ':' |

### 27 进制编码（普通属性）

字符映射：`k % 27 + 64` → ASCII 字符

```text
余数    ASCII    字符
────────────────────
0       64       '@'
1       65       'A'
2       66       'B'
...     ...      ...
26      90       'Z'
```

### 解码算法

```rust
/// 基于 db_tool.rs 中的 db1_dehash_uncached
fn decode_hash_to_name(hash: u32) -> String {
    let mut result = String::new();
    
    if hash > 0x171FAD39 {
        // UDA 属性：64 进制编码
        let mut k = ((hash - 0x171FAD39) % 0x1000000) as i32;
        result.push(':');
        for _ in 0..6 {
            if k <= 0 { break; }
            result.push((k % 64 + 32) as u8 as char);
            k /= 64;
        }
    } else if hash > 0x81BF1 {
        // 普通属性：27 进制编码
        let mut k = (hash - 0x81BF1) as i32;
        while k > 0 {
            result.push((k % 27 + 64) as u8 as char);
            k /= 27;
        }
    }
    
    result
}
```

### 编码示例

```text
属性名    哈希值         计算过程
──────────────────────────────────────────
NAME      0x0009C18E     k=639373, 解码得 NAME
SIZE      0x0009E770     k=649071, 解码得 SIZE
TYPE      0x000C8E22     解码得 TYPE (原始为 TRUNA 的反向)
DESC      0x000143CD     解码得 DESC
```

### UDA 属性示例

```text
UDA 属性以 ':' 开头，如 :MYUDA
哈希 > 0x171FAD39 时使用 64 进制编码
```

## 示例数据解析

### 原始数据（十六进制）

```text
页 0 (偏移 0x1000):
0009E770 00000003 00000002 00000001  ; hash=SIZE, type=INT, flag=有默认值, value=1
000D3372 00000003 00000001           ; hash=DTYP, type=INT, flag=无默认值
0034482B 00000001 00000002 00000002  ; hash=FLBAT, type=LOG, flag=有默认值, value=TRUE
```

### 解析结果

| 哈希 | 名称 | 类型 | 默认值 |
|------|------|------|--------|
| 0x0009E770 | SIZE | INT | 1 |
| 0x000D3372 | DTYP | INT | (无) |
| 0x0034482B | TABLF | LOG | TRUE |

## 数据验证规则

1. **哈希范围**：531442 ≤ hash ≤ 387951929
2. **数据类型**：1 ≤ type ≤ 4
3. **默认标志**：flag ∈ {1, 2}
4. **页边界**：word_idx < 512
5. **段结束**：遇到 0xFFFFFFFF 停止

## 相关资料

- IDA Pro 分析：`ATTLIB_Load_Index_ATGTIX` @ 0x10852A64
- IDA Pro 分析：`ATTLIB_Load_Def_ATGTDF` @ 0x10852E20
- FHDBRN 分页读取：`FHDBRN` @ 0x10766040
