#!/usr/bin/env python3
"""
ATGTIX-2 解析流程线段线框图
使用简洁的线段图表示 parse_atgtix2.py 的执行流程
"""

def generate_wireframe_diagram():
    """生成线段线框图表示的解析流程"""
    
    diagram = '''
ATGTIX-2 解析流程线段线框图
═══════════════════════════════════════════════════════════════

1. 初始化阶段
┌─────────────────────────────────────────────────────────────┐
│ 开始 → 检查参数 → 打开attlib.dat文件                           │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼

2. 页面加载阶段 (load_pages)
┌─────────────────────────────────────────────────────────────┐
│ 计算文件大小 → 计算数据区域大小 → 计算总页数                    │
│     │              │                │                        │
│     ▼              ▼                ▼                        │
│ 逐页读取2048字节 → 解包为512个32位整数 → 存储到pages列表        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼

3. 起始页检测阶段 (find_best_start_page)
┌─────────────────────────────────────────────────────────────┐
│ 遍历所有页面                                                     │
│     │                                                          │
│     ├─→ 页面包含有效哈希? ──NO─→ 跳过                           │
│     │     │                                                  │
│     │    YES                                                  │
│     │     │                                                  │
│     ▼     ▼                                                  │
│ parse_index_from_page ──→ 遇到SEGMENT_END? ──NO─→ 继续下一页     │
│     │                    │                                  │
│     │                   YES                                  │
│     │                    │                                  │
│     ▼                    ▼                                  │
│ 包含PIPE/SITE哈希? ──NO─→ 继续下一页                           │
│     │                                                          │
│    YES                                                          │
│     │                                                          │
│     ▼                                                          │
│ 记录数更多? ──YES─→ 更新最佳页面 ──→ 继续遍历                    │
│     │                                                          │
│    NO                                                          │
│     │                                                          │
│     ▼                                                          │
│ 继续下一页                                                     │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼

4. 正式解析阶段 (parse_index_from_page)
┌─────────────────────────────────────────────────────────────┐
│ 从起始页开始                                                     │
│     │                                                          │
│     ├─→ 页面越界? ──YES─→ 返回记录列表                          │
│     │     │                                                  │
│     │    NO                                                   │
│     │     │                                                  │
│     ▼     ▼                                                  │
│ 索引越界? ──YES─→ 切换到下一页 ──→ 页面越界检查                   │
│     │                                                          │
│    NO                                                           │
│     │                                                          │
│     ▼                                                          │
│ 读取当前word                                                   │
│     │                                                          │
│     ├─→ word == PAGE_SWITCH? ──YES─→ 切换页面                  │
│     │     │                                                  │
│     │    NO                                                   │
│     │     │                                                  │
│     ▼     ▼                                                  │
│ word == SEGMENT_END? ──YES─→ 标记结束 → 返回记录列表             │
│     │                                                          │
│    NO                                                           │
│     │     │                                                  │
│     ▼     ▼                                                  │
│ word在哈希范围内? ──NO─→ 跳过 → 继续下一个word                  │
│     │                                                          │
│    YES                                                          │
│     │                                                          │
│     ▼                                                          │
│ 读取combined值                                                 │
│     │                                                          │
│     ▼                                                          │
│ 计算页面号 (combined // 512)                                   │
│     │                                                          │
│     ▼                                                          │
│ 计算偏移 (combined % 512)                                      │
│     │                                                          │
│     ▼                                                          │
│ 添加记录 (hash, page, offset, combined)                       │
│     │                                                          │
│     ▼                                                          │
│ 继续下一个word                                                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼

5. Base27解码阶段 (decode_base27)
┌─────────────────────────────────────────────────────────────┐
│ hash在有效范围? ──NO─→ 返回空字符串                            │
│     │                                                          │
│    YES                                                          │
│     │                                                          │
│     ▼                                                          │
│ k = hash - BASE27_OFFSET                                      │
│     │                                                          │
│     ▼                                                          │
│ Base27解码循环:                                                │
│     │                                                          │
│     ├─→ k > 0? ──NO─→ 返回解码结果                             │
│     │     │                                                  │
│     │    YES                                                  │
│     │     │                                                  │
│     ▼     ▼                                                  │
│ c = k % 27                                                     │
│     │                                                          │
│     ├─→ c == 0? ──YES─→ 添加空格                              │
│     │     │                                                  │
│     │    NO                                                   │
│     │     │                                                  │
│     ▼     ▼                                                  │
│ 添加chr(c + 64)                                               │
│     │                                                          │
│     ▼                                                          │
│ k //= 27 ──→ 继续循环                                          │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼

6. 输出阶段
┌─────────────────────────────────────────────────────────────┐
│ 写入CSV表头 → 遍历所有记录 → Base27解码 → 写入CSV行             │
│     │              │              │           │               │
│     └──────────────┴──────────────┴───────────┘               │
│                                │                              │
│                                ▼                              │
│ 完成输出 → 打印统计信息 → 返回成功码0                           │
└─────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════

核心数据结构线框图
═══════════════════════════════════════════════════════════════

页面结构 (Page Structure)
┌─────────────────────────────────────────────────────────────┐
│ 页面大小: 2048字节                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 每512个32位整数 = 2048字节                              │ │
│ │ [0][1][2]...[511]                                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│ 数据区域: 从0x1000偏移开始                                   │
└─────────────────────────────────────────────────────────────┘

记录格式 (Record Format)
┌─────────────────────────────────────────────────────────────┐
│ 每条记录 = (hash, page, offset, combined)                    │
│ ┌─────────────┬─────────────┬─────────────┬─────────────┐   │
│ │ noun_hash   │ page        │ offset      │ combined    │   │
│ │ (8字节)     │ (4字节)     │ (4字节)     │ (4字节)     │   │
│ └─────────────┴─────────────┴─────────────┴─────────────┘   │
│ combined = page * 512 + offset                              │
└─────────────────────────────────────────────────────────────┘

特殊标记 (Special Markers)
┌─────────────────────────────────────────────────────────────┐
│ PAGE_SWITCH = 0x00000000    ←── 页面切换信号                  │
│ SEGMENT_END = 0xFFFFFFFF    ←── 段结束信号                   │
│ MIN_HASH = 0x81BF2          ←── 有效哈希下限                  │
│ MAX_HASH = 0x171FAD39       ←── 有效哈希上限                  │
└─────────────────────────────────────────────────────────────┘

Base27解码算法线框
┌─────────────────────────────────────────────────────────────┐
│ 输入: hash值                                                  │
│     │                                                          │
│     ▼                                                          │
│ k = hash - 0x81BF1                                            │
│     │                                                          │
│     ▼                                                          │
│ while k > 0:                                                  │
│     │                                                          │
│     ├─→ c = k % 27                                            │
│     │     │                                                  │
│     │     ├─→ c == 0: 添加空格                                 │
│     │     └─→ c > 0:  添加chr(c + 64)                        │
│     │                                                          │
│     └─→ k //= 27                                              │
│     │                                                          │
│     ▼                                                          │
│ 反转字符串 → 输出noun名称                                      │
└─────────────────────────────────────────────────────────────┘
'''
    
    return diagram

if __name__ == "__main__":
    print(generate_wireframe_diagram())
