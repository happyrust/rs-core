# attlib_parser 使用示例

## 基本解析

```rust
use aios_core::attlib_parser::AttlibParser;

fn main() -> std::io::Result<()> {
    // 创建解析器
    let mut parser = AttlibParser::new("data/attlib.dat")?;
    
    // 加载所有数据
    parser.load_all()?;
    
    // 输出统计信息
    println!("索引数量: {}", parser.stats.atgtix_count);
    println!("定义数量: {}", parser.stats.atgtdf_count);
    
    Ok(())
}
```

## 按名称查询属性

```rust
use aios_core::attlib_parser::{AttlibParser, encode_base27};

fn query_by_name(parser: &AttlibParser, name: &str) {
    let hash = encode_base27(name);
    
    if let Some(def) = parser.get_attribute(hash) {
        println!("属性: {}", name);
        println!("  哈希: 0x{:08X}", def.attr_hash);
        println!("  类型: {}", def.data_type);
        println!("  默认标志: {}", def.default_flag);
    } else {
        println!("属性 {} 未找到", name);
    }
}
```

## 获取完整属性信息

```rust
use aios_core::attlib_parser::AttlibParser;

fn show_full_attribute(parser: &AttlibParser, hash: u32) {
    if let Some(attr) = parser.get_full_attribute(hash) {
        println!("名称: {}", attr.name);
        println!("类型: {:?}", attr.data_type);
        println!("哈希: 0x{:08X}", attr.hash);
        
        if let Some(default) = &attr.default_text {
            println!("默认值: {}", default);
        }
    }
}
```

## 按类型筛选属性

```rust
use aios_core::attlib_parser::{AttlibParser, AttlibDataType};
use std::collections::HashMap;

fn group_by_type(parser: &AttlibParser) {
    let attrs = parser.list_all_attributes();
    
    let mut by_type: HashMap<AttlibDataType, Vec<_>> = HashMap::new();
    for attr in attrs {
        by_type.entry(attr.data_type).or_default().push(attr);
    }
    
    for (dtype, list) in &by_type {
        println!("{:?}: {} 个属性", dtype, list.len());
    }
}
```

## 导出为 JSON

```rust
use aios_core::attlib_parser::AttlibParser;

fn export_to_json(parser: &AttlibParser, output_path: &str) -> std::io::Result<()> {
    let json = parser.export_json()
        .map_err(|e| std::io::Error::new(std::io::ErrorKind::Other, e))?;
    
    std::fs::write(output_path, json)?;
    println!("已导出到: {}", output_path);
    
    Ok(())
}
```

## 27 进制编解码

```rust
use aios_core::attlib_parser::{encode_base27, decode_hash_to_name, decode_base27};

fn encoding_examples() {
    // 名称 → 哈希
    let hash = encode_base27("NAME");
    println!("NAME → 0x{:08X}", hash);  // NAME → 0x000438A7
    
    // 哈希 → 名称
    let name = decode_hash_to_name(0x000438A7);
    println!("0x000438A7 → {}", name);  // 0x000438A7 → NAME
    
    // 解码 27 进制编码的文本数据
    let words = vec![123456u32, 789012u32];
    let text = decode_base27(&words);
    println!("解码文本: {}", text);
}
```

## 遍历索引表

```rust
use aios_core::attlib_parser::{AttlibParser, decode_hash_to_name};

fn list_indices(parser: &AttlibParser) {
    for (hash, index) in &parser.attr_index {
        let name = decode_hash_to_name(*hash);
        println!("{:8} hash=0x{:08X} record={} slot={}", 
            name, 
            index.attr_hash,
            index.record_num(),
            index.slot_offset());
    }
}
```

## 查找有默认值的属性

```rust
use aios_core::attlib_parser::{AttlibParser, AttlibDefaultValue};

fn find_with_defaults(parser: &AttlibParser) {
    for attr in parser.list_all_attributes() {
        match &attr.default_value {
            AttlibDefaultValue::None => continue,
            AttlibDefaultValue::Scalar(v) => {
                println!("{}: 标量默认值 = {}", attr.name, v);
            }
            AttlibDefaultValue::Text(words) => {
                println!("{}: 文本默认值 ({} 字)", attr.name, words.len());
            }
        }
    }
}
```

## 完整示例程序

```rust
//! cargo run --example parse_attlib

use aios_core::attlib_parser::{AttlibParser, AttlibDataType};

fn main() -> std::io::Result<()> {
    let mut parser = AttlibParser::new("data/attlib.dat")?;
    parser.load_all()?;
    
    println!("=== 统计 ===");
    println!("  索引: {} 条", parser.stats.atgtix_count);
    println!("  定义: {} 条", parser.stats.atgtdf_count);
    
    println!("\n=== 按类型分布 ===");
    let attrs = parser.list_all_attributes();
    let log_count = attrs.iter().filter(|a| a.data_type == AttlibDataType::Log).count();
    let int_count = attrs.iter().filter(|a| a.data_type == AttlibDataType::Int).count();
    let real_count = attrs.iter().filter(|a| a.data_type == AttlibDataType::Real).count();
    let text_count = attrs.iter().filter(|a| a.data_type == AttlibDataType::Text).count();
    
    println!("  LOG:  {} 个", log_count);
    println!("  INT:  {} 个", int_count);
    println!("  REAL: {} 个", real_count);
    println!("  TEXT: {} 个", text_count);
    
    println!("\n=== 前 10 个属性 ===");
    for (i, attr) in attrs.iter().take(10).enumerate() {
        let default = attr.default_text.as_deref().unwrap_or("-");
        println!("  {}. {} ({:?}) = {}", i + 1, attr.name, attr.data_type, default);
    }
    
    Ok(())
}
```

## 命令行运行

```bash
# 基本解析
cargo run --example parse_attlib

# 导出 JSON
cargo run --example parse_attlib -- --json

# 查看输出
cat attlib_parsed.json | jq '.[:5]'
```

## 输出示例

```text
=== attlib.dat 解析开始 ===

加载属性定义（从页 0 开始）...
    [0] hash=0x0009E770 name=AEZIS  type=INT flag=2
    [1] hash=0x000D3372 name=APYTD  type=INT flag=1
    [2] hash=0x0034482B name=FLBAT  type=LOG flag=2
  属性定义加载完成，共 58 条记录

加载 ATGTIX-1 段（属性索引），起始页: 2098
  ATGTIX 加载完成，共 5608 条记录

=== 解析完成 ===
  ATGTIX 索引: 6764 条
  ATGTDF 定义: 58 条
```
