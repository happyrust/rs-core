# 常用查询方法

本文档总结了 aios-core 中常用的 SurrealDB 查询方法。

## 查询扩展 trait

所有查询都通过 `SurrealQueryExt` trait 执行：

```rust
use aios_core::{SUL_DB, SurrealQueryExt};

// 单结果查询（提取第 N 条语句结果）
let result: Vec<T> = SUL_DB.query_take(sql, 0).await?;

// 多结果查询
let mut resp = SUL_DB.query_response(sql).await?;
let data1: Vec<T1> = resp.take(0)?;
let data2: Vec<T2> = resp.take(1)?;
```

---

## 几何实例查询

### query_insts - 查询几何实例

```rust
use aios_core::rs_surreal::query_insts;

let refnos: Vec<RefnoEnum> = vec![...];
let geom_insts: Vec<GeomInstQuery> = query_insts(&refnos, enable_holes).await?;
```

**参数**:

- `refnos`: 构件编号列表
- `enable_holes`: 是否启用孔洞查询

**返回**: `GeomInstQuery` 包含几何实例信息

---

### query_tubi_insts_by_brans - 查询管道直段

```rust
use aios_core::rs_surreal::query_tubi_insts_by_brans;

let bran_refnos: Vec<RefnoEnum> = vec![...];
let tubi_insts: Vec<TubiInstQuery> = query_tubi_insts_by_brans(&bran_refnos).await?;
```

使用 ID Range 查询，详见 [tubi_relate 查询指南](./tubi_relate查询指南.md)

---

### query_insts_by_zone - 按区域查询

```rust
use aios_core::rs_surreal::query_insts_by_zone;

let zone_refnos: Vec<RefnoEnum> = vec![...];
let geom_insts: Vec<GeomInstQuery> = query_insts_by_zone(&zone_refnos, enable_holes).await?;
```

---

## 层级查询

### collect_descendant_filter_ids - 子孙节点 ID

```rust
use aios_core::collect_descendant_filter_ids;

let ids = collect_descendant_filter_ids(
    &[root_refno],
    &["EQUI", "PIPE"],  // 类型过滤
    Some("1..5"),       // 层级范围 (可选)
).await?;
```

### collect_children_filter_ids - 子节点 ID

```rust
use aios_core::collect_children_filter_ids;

let children = collect_children_filter_ids(
    root_refno,
    &["BRAN", "HANG"],  // 类型过滤
).await?;
```

### query_filter_ancestors - 祖先查询

```rust
use aios_core::query_filter_ancestors;

let zones = query_filter_ancestors(
    refno,
    &["ZONE"],  // 目标类型
).await?;
```

---

## PE 元素查询

### get_pe - 获取单个元素

```rust
use aios_core::get_pe;

if let Ok(Some(pe)) = get_pe(refno).await {
    println!("name: {}, noun: {}", pe.name, pe.noun);
}
```

### get_named_attmap - 获取属性映射

```rust
use aios_core::get_named_attmap;

let attmap = get_named_attmap(refno).await?;
let pos = attmap.get_vec3("PPOS");
let name = attmap.get_as_string("NAME");
```

### get_world_transform - 获取世界变换

```rust
use aios_core::get_world_transform;

if let Ok(Some(transform)) = get_world_transform(refno).await {
    let world_pos = transform.translation;
}
```

---

## SurrealDB ID Range 查询

对于使用复合 ID 的表，推荐使用 ID Range 查询：

```sql
-- 查询 tubi_relate 中某个 BRAN 下的所有记录
SELECT * FROM tubi_relate:[pe:⟨bran_refno⟩, 0]..[pe:⟨bran_refno⟩, ..]

-- 查询 neg_relate 中某个负实体的所有关系
SELECT * FROM neg_relate:[pe:⟨neg_refno⟩, 0]..[pe:⟨neg_refno⟩, ..]
```

**语法说明**:

- `[start_id]..[end_id]`: ID 范围
- `..`: 表示无穷大（用于 end_id 的第二个元素）

---

## 去重查询 (array::distinct)

**重要**: SurrealDB **不支持** `SELECT DISTINCT` 关键字，必须使用 `array::distinct()` 函数实现去重。

### 基本用法

```sql
-- ❌ 错误 - SurrealDB 不支持
SELECT DISTINCT field FROM table;

-- ✅ 正确 - 使用 array::distinct()
SELECT array::distinct((SELECT VALUE field FROM table)) AS unique_values;
```

### 实际示例

```sql
-- 从 tubi_relate 获取所有不重复的 bran_owner
SELECT array::distinct(
    (SELECT VALUE id[0] FROM tubi_relate WHERE aabb.d != NONE)
) AS bran_owners;

-- 图遍历结果去重
SELECT id, array::distinct(<-requires<-course<-requires<-course) AS indirect 
FROM course 
WHERE id = course:APS105;
```

### 数组元素去重

```sql
-- 对数组字面量去重
SELECT array::distinct([1, 2, 1, 3, 3, 4]) AS unique_values;
-- 返回: [1, 2, 3, 4]

-- 对字段中的数组去重
SELECT array::distinct(tags) AS unique_tags FROM article;
```

### 结合 GROUP BY 实现去重

另一种替代方案是使用 `GROUP BY`：

```sql
-- 按字段分组实现去重效果
SELECT field FROM table GROUP BY field;

-- 获取不重复的 bran_owner
SELECT id[0] as bran_owner FROM tubi_relate 
WHERE aabb.d != NONE 
GROUP BY id[0];
```

---

## 查询数量

```sql
-- 查询表中记录总数
SELECT value count() FROM ONLY pe GROUP ALL LIMIT 1;

-- 按条件查询数量
SELECT value count() FROM ONLY pe WHERE noun = 'PIPE' GROUP ALL LIMIT 1;
```

---

## 最佳实践

### 1. 使用类型安全的目标类型

```rust
// ✅ 推荐
let refnos: Vec<RefnoEnum> = SUL_DB.query_take(sql, 0).await?;

// ❌ 避免
let values: Vec<serde_json::Value> = SUL_DB.query_take(sql, 0).await?;
```

### 2. 批量查询优于循环查询

```rust
// ✅ 推荐
let sql = format!("SELECT * FROM pe WHERE id IN [{}]", pe_keys.join(","));

// ❌ 避免
for refno in refnos {
    let result = SUL_DB.query_take(&format!("SELECT * FROM pe:{}", refno), 0).await?;
}
```

### 3. 使用 ID Range 替代 WHERE 条件

```rust
// ✅ 推荐 - 使用 ID Range
let sql = format!("SELECT * FROM tubi_relate:[{}, 0]..[{}, ..]", pe_key, pe_key);

// ❌ 避免 - 使用 WHERE 过滤
let sql = format!("SELECT * FROM tubi_relate WHERE record::id(id)[0] = {}", pe_key);
```

### 4. 直接访问字段，避免 record::id()

```rust
// ✅ 推荐
"SELECT id[0] as refno, in as leave FROM tubi_relate:..."

// ❌ 避免
"SELECT record::id(id)[0] as refno, in as leave FROM tubi_relate:..."
```

---

## 代码位置

- **查询扩展**: `src/rs_surreal/query_ext.rs`
- **实例查询**: `src/rs_surreal/inst.rs`
- **层级查询**: `src/rs_surreal/graph.rs`
- **PE 查询**: `src/rs_surreal/query.rs`
