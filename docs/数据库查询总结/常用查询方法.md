# 常用查询方法

本文档总结了 aios-core 中常用的 SurrealDB 查询方法。

---

## SurrealValue 类型规范（重要）

### 基本原则

**必须使用 `SurrealValue` trait，禁止使用 `serde_json::Value`**

```rust
use surrealdb::types::{self as surrealdb_types, SurrealValue};

// ✅ 正确：使用 SurrealValue derive 宏
#[derive(Serialize, Deserialize, Debug, SurrealValue)]
pub struct MyQueryResult {
    pub refno: RefnoEnum,
    pub name: String,
    pub world_aabb: PlantAabb,
}

// ❌ 错误：使用 serde_json::Value
let result: Vec<serde_json::Value> = SUL_DB.query_take(sql, 0).await?;
```

### ID 类型选择

- **返回 ID 字段**：使用 `RefU64` 或 `RefnoEnum`（已兼容自动转换）
- **可选 ID**：使用 `Option<RefnoEnum>`
- **时间戳**：使用 `surrealdb::types::Datetime`

```rust
#[derive(Serialize, Deserialize, Debug, SurrealValue)]
pub struct GeomInstQuery {
    #[serde(alias = "id")]
    pub refno: RefnoEnum,           // 主键
    pub old_refno: Option<RefnoEnum>, // 可选历史引用
    pub date: Option<surrealdb::types::Datetime>, // 时间戳
}
```

---

## 查询扩展 trait

所有查询都通过 `SurrealQueryExt` trait 执行：

```rust
use aios_core::{SUL_DB, SurrealQueryExt};

// 单结果查询（提取第 N 条语句结果）
let result: Vec<T> = SUL_DB.query_take(sql, 0).await?;

// 多结果查询
let mut resp = SUL_DB.query_response(sql).await?;
let data1: Vec<T1> = resp.take(0)?;
let data2: Vec<T2> = resp.take(1)?;
```

---

## 几何实例查询

### query_insts - 查询几何实例

```rust
use aios_core::rs_surreal::query_insts;

let refnos: Vec<RefnoEnum> = vec![...];
let geom_insts: Vec<GeomInstQuery> = query_insts(&refnos, enable_holes).await?;
```

**参数**:

- `refnos`: 构件编号列表
- `enable_holes`: 是否启用孔洞查询

**返回**: `GeomInstQuery` 包含几何实例信息

---

### query_tubi_insts_by_brans - 查询管道直段

```rust
use aios_core::rs_surreal::query_tubi_insts_by_brans;

let bran_refnos: Vec<RefnoEnum> = vec![...];
let tubi_insts: Vec<TubiInstQuery> = query_tubi_insts_by_brans(&bran_refnos).await?;
```

使用 ID Range 查询，详见 [tubi_relate 查询指南](./tubi_relate查询指南.md)

---

### query_insts_by_zone - 按区域查询

```rust
use aios_core::rs_surreal::query_insts_by_zone;

let zone_refnos: Vec<RefnoEnum> = vec![...];
let geom_insts: Vec<GeomInstQuery> = query_insts_by_zone(&zone_refnos, enable_holes).await?;
```

---

## 层级查询

### collect_descendant_filter_ids - 子孙节点 ID

```rust
use aios_core::collect_descendant_filter_ids;

let ids = collect_descendant_filter_ids(
    &[root_refno],
    &["EQUI", "PIPE"],  // 类型过滤
    Some("1..5"),       // 层级范围 (可选)
).await?;
```

### collect_children_filter_ids - 子节点 ID

```rust
use aios_core::collect_children_filter_ids;

let children = collect_children_filter_ids(
    root_refno,
    &["BRAN", "HANG"],  // 类型过滤
).await?;
```

### query_filter_ancestors - 祖先查询

```rust
use aios_core::query_filter_ancestors;

let zones = query_filter_ancestors(
    refno,
    &["ZONE"],  // 目标类型
).await?;
```

---

## 泛型查询函数族（推荐）

项目提供了一组高性能的泛型查询函数，支持自定义 SELECT 表达式和返回类型。

### collect_descendant_with_expr - 泛型子孙查询

```rust
use aios_core::collect_descendant_with_expr;

// 查询 ID 列表
let ids: Vec<RefnoEnum> = collect_descendant_with_expr(
    &[refno], &["EQUI"], None, "VALUE id"
).await?;

// 查询完整元素
let elements: Vec<SPdmsElement> = collect_descendant_with_expr(
    &[refno], &["EQUI", "PIPE"], None, "*"
).await?;

// 查询属性映射（带层级范围）
let attrs: Vec<NamedAttrMap> = collect_descendant_with_expr(
    &[refno], &["ZONE"], Some("1..5"), "VALUE id.refno.*"
).await?;
```

**参数说明**：
- `refnos`: 起始节点数组（支持批量查询多个起点）
- `nouns`: 类型过滤数组，空数组表示不过滤
- `range_str`: 递归范围，如 `None`（无限）、`Some("1..5")`（1-5层）、`Some("3")`（固定3层）
- `select_expr`: SELECT 表达式，如 `"VALUE id"`、`"*"`、`"VALUE id.refno.*"`

### collect_children_with_expr - 泛型子节点查询

```rust
use aios_core::collect_children_with_expr;

// 查询直接子节点 ID
let ids: Vec<RefnoEnum> = collect_children_with_expr(
    refno, &["EQUI"], "VALUE id"
).await?;

// 查询直接子节点完整属性
let attrs: Vec<NamedAttrMap> = collect_children_with_expr(
    refno, &["EQUI"], "VALUE id.refno.*"
).await?;
```

### 便捷封装函数

| 函数名 | 功能 | 等价表达式 |
|--------|------|-----------|
| `collect_descendant_filter_ids` | 子孙 ID 列表 | `"VALUE id"` |
| `collect_descendant_elements` | 子孙完整元素 | `"*"` |
| `collect_descendant_full_attrs` | 子孙属性映射 | `"VALUE id.refno.*"` |
| `collect_children_filter_ids` | 子节点 ID 列表 | `"VALUE id"` |
| `collect_children_filter_attrs` | 子节点属性 | `"VALUE id.refno.*"` |
| `collect_children_elements` | 子节点完整元素 | `"*"` |

---

## 数据库端函数调用

项目定义了多个 SurrealDB 自定义函数，在数据库端执行复杂逻辑，大幅提升性能。

### fn::collect_descendants_filter_spre - 过滤 SPRE/CATR 节点

```rust
let sql = format!(
    "fn::collect_descendants_filter_spre({}, [], {}, none, \"..\")",
    pe_key, filter_str
);
let refnos: Vec<RefnoEnum> = SUL_DB.query_take(&sql, 0).await?;
```

### fn::collect_descendants_filter_inst - 过滤已有实例节点

```rust
// 过滤掉已有 inst_relate 或 tubi_relate 的节点
let sql = format!(
    "fn::collect_descendants_filter_inst({}, {}, {}, true, false)",
    pe_key, types_expr, filter_str
);
```

### fn::visible_geo_descendants - 可见几何节点

```rust
let sql = format!(
    "SELECT VALUE fn::visible_geo_descendants({}, {}, \"{}\")",
    pe_key, include_self, range
);
```

### fn::negative_geo_descendants - 负实体几何节点

```rust
let sql = format!(
    "SELECT VALUE fn::negative_geo_descendants({}, {}, \"{}\")",
    pe_key, include_self, range
);
```

### fn::ancestor - 祖先节点查询

```rust
let sql = format!("return fn::ancestor({}).refno;", pe_key);
let ancestors: Vec<RefnoEnum> = SUL_DB.query_take(&sql, 0).await?;
```

---

## 批量查询优化模式

### array::map + array::flatten + array::distinct 模式

对多个起点进行批量查询时，使用此模式在数据库端完成所有处理：

```rust
let sql = format!(
    r#"
    array::distinct(array::filter(array::flatten(array::map([{}], |$refno|
        fn::collect_descendants_filter_inst($refno, {}, {}, true, false)
    )), |$v| $v != none))
    "#,
    refno_list, types_expr, filter_str
);
```

**性能对比**：
- 旧实现（2000节点）: ~55ms（1次收集 + 10次分块过滤）
- 新实现（2000节点）: ~5ms（1次数据库端处理）
- **提升: 91%**

---

## PE 元素查询

### get_pe - 获取单个元素

```rust
use aios_core::get_pe;

if let Ok(Some(pe)) = get_pe(refno).await {
    println!("name: {}, noun: {}", pe.name, pe.noun);
}
```

### get_named_attmap - 获取属性映射

```rust
use aios_core::get_named_attmap;

let attmap = get_named_attmap(refno).await?;
let pos = attmap.get_vec3("PPOS");
let name = attmap.get_as_string("NAME");
```

### get_world_transform - 获取世界变换

```rust
use aios_core::get_world_transform;

if let Ok(Some(transform)) = get_world_transform(refno).await {
    let world_pos = transform.translation;
}
```

---

## SurrealDB ID Range 查询

对于使用复合 ID 的表，推荐使用 ID Range 查询：

```sql
-- 查询 tubi_relate 中某个 BRAN 下的所有记录
SELECT * FROM tubi_relate:[pe:⟨bran_refno⟩, 0]..[pe:⟨bran_refno⟩, ..]

-- 查询 neg_relate 中某个负实体的所有关系
SELECT * FROM neg_relate:[pe:⟨neg_refno⟩, 0]..[pe:⟨neg_refno⟩, ..]
```

**语法说明**:

- `[start_id]..[end_id]`: ID 范围
- `..`: 表示无穷大（用于 end_id 的第二个元素）

---

## 去重查询 (array::distinct)

**重要**: SurrealDB **不支持** `SELECT DISTINCT` 关键字，必须使用 `array::distinct()` 函数实现去重。

### 基本用法

```sql
-- ❌ 错误 - SurrealDB 不支持
SELECT DISTINCT field FROM table;

-- ✅ 正确 - 使用 array::distinct()
SELECT array::distinct((SELECT VALUE field FROM table)) AS unique_values;
```

### 实际示例

```sql
-- 从 tubi_relate 获取所有不重复的 bran_owner
SELECT array::distinct(
    (SELECT VALUE id[0] FROM tubi_relate WHERE aabb.d != NONE)
) AS bran_owners;

-- 图遍历结果去重
SELECT id, array::distinct(<-requires<-course<-requires<-course) AS indirect 
FROM course 
WHERE id = course:APS105;
```

### 数组元素去重

```sql
-- 对数组字面量去重
SELECT array::distinct([1, 2, 1, 3, 3, 4]) AS unique_values;
-- 返回: [1, 2, 3, 4]

-- 对字段中的数组去重
SELECT array::distinct(tags) AS unique_tags FROM article;
```

### 结合 GROUP BY 实现去重

另一种替代方案是使用 `GROUP BY`：

```sql
-- 按字段分组实现去重效果
SELECT field FROM table GROUP BY field;

-- 获取不重复的 bran_owner
SELECT id[0] as bran_owner FROM tubi_relate 
WHERE aabb.d != NONE 
GROUP BY id[0];
```

---

## 查询数量

```sql
-- 查询表中记录总数
SELECT value count() FROM ONLY pe GROUP ALL LIMIT 1;

-- 按条件查询数量
SELECT value count() FROM ONLY pe WHERE noun = 'PIPE' GROUP ALL LIMIT 1;
```

---

## 最佳实践

### 1. 使用类型安全的目标类型

```rust
// ✅ 推荐
let refnos: Vec<RefnoEnum> = SUL_DB.query_take(sql, 0).await?;

// ❌ 避免
let values: Vec<serde_json::Value> = SUL_DB.query_take(sql, 0).await?;
```

### 2. 批量查询优于循环查询

```rust
// ✅ 推荐
let sql = format!("SELECT * FROM pe WHERE id IN [{}]", pe_keys.join(","));

// ❌ 避免
for refno in refnos {
    let result = SUL_DB.query_take(&format!("SELECT * FROM pe:{}", refno), 0).await?;
}
```

### 3. 使用 ID Range 替代 WHERE 条件

```rust
// ✅ 推荐 - 使用 ID Range
let sql = format!("SELECT * FROM tubi_relate:[{}, 0]..[{}, ..]", pe_key, pe_key);

// ❌ 避免 - 使用 WHERE 过滤
let sql = format!("SELECT * FROM tubi_relate WHERE record::id(id)[0] = {}", pe_key);
```

### 4. 直接访问字段，避免 record::id()

```rust
// ✅ 推荐
"SELECT id[0] as refno, in as leave FROM tubi_relate:..."

// ❌ 避免
"SELECT record::id(id)[0] as refno, in as leave FROM tubi_relate:..."
```

---

## 代码位置

- **查询扩展**: `src/rs_surreal/query_ext.rs`
- **实例查询**: `src/rs_surreal/inst.rs`
- **层级查询**: `src/rs_surreal/graph.rs`
- **PE 查询**: `src/rs_surreal/query.rs`
