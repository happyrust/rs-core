# SurrealDB 数据库架构

本文档描述了 aios-core 中使用的 SurrealDB 数据库表结构。

## 核心表概览

| 表名 | 类型 | 说明 |
|------|------|------|
| `pe` | 节点表 | PDMS 元素主表 |
| `inst_relate` | 关系表 | PE 元素与几何实例的关联 |
| `inst_info` | 节点表 | 几何实例信息 |
| `inst_geo` | 节点表 | 几何数据 |
| `geo_relate` | 关系表 | 实例与几何数据的关联 |
| `tubi_relate` | 关系表 | 管道直段关系 |
| `neg_relate` | 关系表 | 负实体关系 |
| `ngmr_relate` | 关系表 | NGMR 负实体关系 |

---

## 表结构详解

### pe 表（PDMS 元素）

存储所有 PDMS/E3D 元素的基本信息。

```rust
// ID 格式: pe:⟨dbnum_refno⟩ 例如 pe:⟨21491_10000⟩
pub struct PeElement {
    pub id: RefnoEnum,
    pub noun: String,           // 类型 (PIPE, ELBO, BRAN 等)
    pub name: String,           // 名称
    pub owner: RefnoEnum,       // 父节点引用
    pub sesno: i32,             // 会话号
    pub dbnum: i32,             // 数据库编号
    pub old_pe: Option<RefnoEnum>, // 历史引用
    pub deleted: bool,          // 是否删除
}
```

---

### inst_relate 表（实例关系）

连接 PE 元素和几何实例，是模型生成的核心关系表。

```rust
// ID 格式: inst_relate:⟨refno⟩
pub struct InstRelate {
    pub id: String,
    pub input: RefnoEnum,           // in: PE 元素引用
    pub out: String,                // out: inst_info 引用
    pub owner: RefnoEnum,           // 所属构件
    pub generic: String,            // 构件类型
    pub aabb: Option<AabbData>,     // 包围盒
    pub world_trans: Option<TransformData>, // 世界变换
    pub booled_id: Option<String>,  // 布尔运算结果 ID
    pub dt: Option<NaiveDateTime>,  // 时间戳
    pub zone_refno: Option<RefnoEnum>, // 区域引用
    pub old_pe: Option<RefnoEnum>,  // 历史 PE
    pub ptset: Option<PtsetData>,   // 点集数据
}
```

**关系方向**: `pe:⟨xxx⟩ -> inst_relate -> inst_info:⟨xxx⟩`

---

### inst_geo 表（几何数据）

存储几何体的参数和状态。

```rust
// ID 格式: inst_geo:⟨geo_hash⟩
pub struct InstGeo {
    pub id: String,
    pub param: serde_json::Value,   // 几何参数 (JSON)
    pub meshed: bool,               // 是否已网格化
    pub visible: bool,              // 是否可见
    pub trans: Option<TransformData>, // 局部变换
    pub geo_type: String,           // 几何类型 (Pos/Neg/CataNeg)
}
```

---

### geo_relate 表（几何关系）

连接实例信息和具体几何数据。

```rust
// ID 格式: geo_relate:⟨hash⟩
pub struct GeoRelate {
    pub id: String,
    pub input: String,              // in: inst_info 引用
    pub out: String,                // out: inst_geo 引用
    pub trans: Option<TransformData>, // 变换矩阵
    pub visible: bool,              // 是否可见
    pub meshed: bool,               // 是否已网格化
    pub geo_type: String,           // 几何类型
    pub geom_refno: Option<String>, // 几何参考号
}
```

**关系方向**: `inst_info:⟨xxx⟩ -> geo_relate -> inst_geo:⟨xxx⟩`

---

### tubi_relate 表（管道直段关系）

存储 BRAN/HANG 下的管道直段信息。

```rust
// ID 格式: tubi_relate:[pe:⟨bran_refno⟩, index]
// 例如: tubi_relate:[pe:⟨21491_10000⟩, 0]
pub struct TubiRelate {
    pub id: String,                 // 复合 ID: [bran_pe_key, index]
    pub input: RefnoEnum,           // in: 起点 PE (leave_refno)
    pub out: RefnoEnum,             // out: 终点 PE (arrive_refno)
    pub geo: Option<String>,        // inst_geo 引用
    pub aabb: Option<AabbData>,     // 包围盒
    pub world_trans: Option<TransformData>, // 世界变换
    pub bore_size: String,          // 管径尺寸
    pub bad: bool,                  // 是否为异常段
    pub system: Option<RefnoEnum>,  // 所属系统
    pub dt: Option<NaiveDateTime>,  // 时间戳
}
```

**复合 ID 说明**:
- `id[0]`: BRAN/HANG 的 pe_key (如 `pe:⟨21491_10000⟩`)
- `id[1]`: 该 BRAN 下的管道段索引 (如 `0`, `1`, `2`...)

**关系方向**: `pe:⟨leave⟩ -> tubi_relate:[pe:⟨bran⟩, idx] -> pe:⟨arrive⟩`

---

### neg_relate 表（负实体关系）

存储布尔运算中的负实体关系。

```rust
// 关系方向: 负实体 -> 正实体 (被减实体)
// ID 格式: neg_relate:[neg_refno, index]
pub struct NegRelate {
    pub input: RefnoEnum,           // in: 负实体 refno
    pub out: RefnoEnum,             // out: 正实体 refno
}
```

---

### ngmr_relate 表（NGMR 负实体关系）

存储 NGMR 类型的负实体关系。

```rust
// 关系方向: 负实体相关元素 -> 正实体
// ID 格式: ngmr_relate:[ele_pe, target_pe, ngmr_pe]
pub struct NgmrRelate {
    pub input: RefnoEnum,           // in: 负实体相关元素
    pub out: RefnoEnum,             // out: 正实体 (目标)
    pub ngmr: RefnoEnum,            // NGMR 几何引用
}
```

---

## 辅助表

### trans 表（变换矩阵）
```rust
// ID 格式: trans:⟨hash⟩
{ id: String, d: Transform }
```

### aabb 表（包围盒）
```rust
// ID 格式: aabb:⟨hash⟩
{ id: String, d: Aabb }
```

### vec3 表（向量）
```rust
// ID 格式: vec3:⟨hash⟩
{ id: String, d: Vec3 }
```

---

## 表关系图

```
                    ┌─────────────┐
                    │     pe      │
                    │ (元素主表)  │
                    └──────┬──────┘
                           │
           ┌───────────────┼───────────────┐
           │               │               │
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ inst_relate │ │ tubi_relate │ │ neg_relate  │
    │ (几何实例)  │ │ (管道直段)  │ │ (负实体)    │
    └──────┬──────┘ └─────────────┘ └─────────────┘
           │
           ▼
    ┌─────────────┐
    │  inst_info  │
    │ (实例信息)  │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │  geo_relate │
    │ (几何关系)  │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │   inst_geo  │
    │ (几何数据)  │
    └─────────────┘
```

---

## 相关代码位置

- **结构体定义**: `src/rs_surreal/inst_structs.rs`
- **查询方法**: `src/rs_surreal/inst.rs`
- **表常量**: `src/rs_surreal/table_const.rs`
