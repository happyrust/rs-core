# SurrealDB 数据库架构

本文档描述了 aios-core 中使用的 SurrealDB 数据库表结构。

## 核心表概览

| 表名 | 类型 | 说明 |
|------|------|------|
| `pe` | 节点表 | PDMS 元素主表 |
| `inst_relate` | 关系表 | PE 元素与几何实例的关联 |
| `inst_info` | 节点表 | 几何实例信息 |
| `inst_geo` | 节点表 | 几何数据 |
| `geo_relate` | 关系表 | 实例与几何数据的关联 |
| `tubi_relate` | 关系表 | 管道直段关系 |
| `neg_relate` | 关系表 | 负实体关系 |
| `ngmr_relate` | 关系表 | NGMR 负实体关系 |
| `tag_name_mapping` | 关系表 | 位号映射（PE 到位号） |
| `measurement` | 节点表 | 测量数据 |
| `annotation` | 节点表 | 批注数据 |
| `dbnum_info_table` | 节点表 | 数据库编号统计信息 |
| `pbs` | 节点表 | PBS（产品分解结构）元素 |
| `pbs_owner` | 关系表 | PBS 层级关系 |

---

## 表结构详解

### pe 表（PDMS 元素）

存储所有 PDMS/E3D 元素的基本信息。

```rust
// ID 格式: pe:⟨dbnum_refno⟩ 例如 pe:⟨21491_10000⟩
pub struct PeElement {
    pub id: RefnoEnum,
    pub noun: String,           // 类型 (PIPE, ELBO, BRAN 等)
    pub name: String,           // 名称
    pub owner: RefnoEnum,       // 父节点引用
    pub sesno: i32,             // 会话号
    pub dbnum: i32,             // 数据库编号
    pub old_pe: Option<RefnoEnum>, // 历史引用
    pub deleted: bool,          // 是否删除
}
```

---

### inst_relate 表（实例关系）

连接 PE 元素和几何实例，是模型生成的核心关系表。

```rust
// ID 格式: inst_relate:⟨refno⟩
pub struct InstRelate {
    pub id: String,
    pub input: RefnoEnum,           // in: PE 元素引用
    pub out: String,                // out: inst_info 引用
    pub owner: RefnoEnum,           // 所属构件
    pub generic: String,            // 构件类型
    pub aabb: Option<AabbData>,     // 包围盒
    pub world_trans: Option<TransformData>, // 世界变换
    pub booled_id: Option<String>,  // 布尔运算结果 ID
    pub dt: Option<NaiveDateTime>,  // 时间戳
    pub zone_refno: Option<RefnoEnum>, // 区域引用
    pub old_pe: Option<RefnoEnum>,  // 历史 PE
    pub ptset: Option<PtsetData>,   // 点集数据
}
```

**关系方向**: `pe:⟨xxx⟩ -> inst_relate -> inst_info:⟨xxx⟩`

---

### inst_geo 表（几何数据）

存储几何体的参数和状态。

```rust
// ID 格式: inst_geo:⟨geo_hash⟩
pub struct InstGeo {
    pub id: String,
    pub param: serde_json::Value,   // 几何参数 (JSON)
    pub meshed: bool,               // 是否已网格化
    pub visible: bool,              // 是否可见
    pub trans: Option<TransformData>, // 局部变换
    pub geo_type: String,           // 几何类型 (Pos/Neg/CataNeg)
}
```

---

### geo_relate 表（几何关系）

连接实例信息和具体几何数据。

```rust
// ID 格式: geo_relate:⟨hash⟩
pub struct GeoRelate {
    pub id: String,
    pub input: String,              // in: inst_info 引用
    pub out: String,                // out: inst_geo 引用
    pub trans: Option<TransformData>, // 变换矩阵
    pub visible: bool,              // 是否可见
    pub meshed: bool,               // 是否已网格化
    pub geo_type: String,           // 几何类型
    pub geom_refno: Option<String>, // 几何参考号
}
```

**关系方向**: `inst_info:⟨xxx⟩ -> geo_relate -> inst_geo:⟨xxx⟩`

---

### tubi_relate 表（管道直段关系）

存储 BRAN/HANG 下的管道直段信息。

```rust
// ID 格式: tubi_relate:[pe:⟨bran_refno⟩, index]
// 例如: tubi_relate:[pe:⟨21491_10000⟩, 0]
pub struct TubiRelate {
    pub id: String,                 // 复合 ID: [bran_pe_key, index]
    pub input: RefnoEnum,           // in: 起点 PE (leave_refno)
    pub out: RefnoEnum,             // out: 终点 PE (arrive_refno)
    pub geo: Option<String>,        // inst_geo 引用
    pub aabb: Option<AabbData>,     // 包围盒
    pub world_trans: Option<TransformData>, // 世界变换
    pub bore_size: String,          // 管径尺寸
    pub bad: bool,                  // 是否为异常段
    pub system: Option<RefnoEnum>,  // 所属系统
    pub dt: Option<NaiveDateTime>,  // 时间戳
}
```

**复合 ID 说明**:
- `id[0]`: BRAN/HANG 的 pe_key (如 `pe:⟨21491_10000⟩`)
- `id[1]`: 该 BRAN 下的管道段索引 (如 `0`, `1`, `2`...)

**关系方向**: `pe:⟨leave⟩ -> tubi_relate:[pe:⟨bran⟩, idx] -> pe:⟨arrive⟩`

---

### neg_relate 表（负实体关系）

存储布尔运算中的负实体关系。

```rust
// 关系方向: 负实体 -> 正实体 (被减实体)
// ID 格式: neg_relate:[neg_refno, index]
pub struct NegRelate {
    pub input: RefnoEnum,           // in: 负实体 refno
    pub out: RefnoEnum,             // out: 正实体 refno
}
```

---

### ngmr_relate 表（NGMR 负实体关系）

存储 NGMR 类型的负实体关系。

```rust
// 关系方向: 负实体相关元素 -> 正实体
// ID 格式: ngmr_relate:[ele_pe, target_pe, ngmr_pe]
pub struct NgmrRelate {
    pub input: RefnoEnum,           // in: 负实体相关元素
    pub out: RefnoEnum,             // out: 正实体 (目标)
    pub ngmr: RefnoEnum,            // NGMR 几何引用
}
```

---

## 扩展业务表

### tag_name_mapping 表（位号映射）

存储 PE 元素到位号（Tag Name）的映射关系。

```rust
// 关系表，连接 PE 和位号信息
pub struct TagNameMapping {
    pub input: RefnoEnum,           // in: PE 元素引用
    pub tag_name: String,           // 位号名称
    pub full_name: String,          // 节点全名
    pub source: String,             // 数据来源（如 "excel", "manual"）
    pub created_at: Datetime,       // 创建时间
    pub updated_at: Option<Datetime>, // 更新时间
}
```

**相关查询函数**:
- `get_tag_name_by_refno()` - 根据 refno 查询位号
- `get_tag_names_by_refnos()` - 批量查询位号
- `upsert_tag_name_mapping()` - 创建或更新映射

---

### measurement 表（测量数据）

存储三维测量数据。

```rust
// ID 格式: measurement:⟨uuid⟩
pub struct Measurement {
    pub id: String,
    pub measurement_type: String,   // 测量类型（distance, angle, area 等）
    pub project_id: Option<String>, // 项目 ID
    pub points: Vec<Vec3>,          // 测量点坐标
    pub value: f64,                 // 测量值
    pub unit: String,               // 单位
    pub created_by: String,         // 创建者
    pub created_at: Datetime,       // 创建时间
    pub status: String,             // 状态
}
```

**相关查询函数**:
- `create_measurement()` - 创建测量
- `list_measurements()` - 列出测量
- `get_measurement_by_id()` - 按 ID 查询

---

### annotation 表（批注数据）

存储三维批注数据。

```rust
// ID 格式: annotation:⟨uuid⟩
pub struct Annotation {
    pub id: String,
    pub annotation_type: String,    // 批注类型
    pub project_id: Option<String>, // 项目 ID
    pub position: Vec3,             // 批注位置
    pub content: String,            // 批注内容
    pub target_refno: Option<RefnoEnum>, // 关联的 PE 元素
    pub created_by: String,         // 创建者
    pub assignee: Option<String>,   // 指派人
    pub status: String,             // 状态
    pub created_at: Datetime,       // 创建时间
}
```

---

### dbnum_info_table 表（数据库统计）

存储各数据库编号的统计信息，由事件自动维护。

```rust
// ID 格式: dbnum_info_table:⟨dbnum⟩
pub struct DbnumInfo {
    pub id: u32,                    // 数据库编号
    pub dbnum: u32,                 // 数据库编号（冗余）
    pub count: u64,                 // PE 记录数量
    pub sesno: i32,                 // 最大会话号
    pub max_ref1: i32,              // 最大 ref1 值
    pub updated_at: Datetime,       // 更新时间
}
```

**自动更新事件**: 通过 `DEFINE EVENT update_dbnum_event ON pe` 自动维护

---

### pbs 表（PBS 元素）

存储产品分解结构（Product Breakdown Structure）元素。

```rust
pub struct PbsElement {
    pub id: RecordId,
    pub name: String,               // 名称
    pub noun: String,               // 类型
    pub deleted: bool,              // 是否删除
    pub children_cnt: Option<i32>,  // 子节点数量
}
```

**层级关系**: 通过 `pbs_owner` 关系表维护

---

## 辅助表

### trans 表（变换矩阵）
```rust
// ID 格式: trans:⟨hash⟩
{ id: String, d: Transform }
```

### aabb 表（包围盒）
```rust
// ID 格式: aabb:⟨hash⟩
{ id: String, d: Aabb }
```

### vec3 表（向量）
```rust
// ID 格式: vec3:⟨hash⟩
{ id: String, d: Vec3 }
```

---

## 表关系图

```
                         ┌─────────────┐
                         │     pe      │
                         │ (元素主表)  │
                         └──────┬──────┘
                                │
        ┌───────────────┬───────┴───────┬───────────────┬─────────────────┐
        │               │               │               │                 │
        ▼               ▼               ▼               ▼                 ▼
 ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌───────────────┐
 │ inst_relate │ │ tubi_relate │ │ neg_relate  │ │ ngmr_relate │ │tag_name_mapping│
 │ (几何实例)  │ │ (管道直段)  │ │ (负实体)    │ │ (NGMR负实体)│ │  (位号映射)   │
 └──────┬──────┘ └─────────────┘ └─────────────┘ └─────────────┘ └───────────────┘
        │
        ▼
 ┌─────────────┐
 │  inst_info  │
 │ (实例信息)  │
 └──────┬──────┘
        │
        ▼
 ┌─────────────┐
 │  geo_relate │
 │ (几何关系)  │
 └──────┬──────┘
        │
        ▼
 ┌─────────────┐
 │   inst_geo  │
 │ (几何数据)  │
 └─────────────┘


                 ┌─────────────┐
                 │     pbs     │
                 │ (PBS元素)   │
                 └──────┬──────┘
                        │
                        ▼
                 ┌─────────────┐
                 │  pbs_owner  │
                 │ (PBS层级)   │
                 └─────────────┘


        独立业务表:
 ┌─────────────┐ ┌─────────────┐ ┌──────────────────┐
 │ measurement │ │ annotation  │ │ dbnum_info_table │
 │  (测量)     │ │  (批注)     │ │   (DB统计)       │
 └─────────────┘ └─────────────┘ └──────────────────┘
```

---

## 相关代码位置

### 核心模块
- **结构体定义**: `src/rs_surreal/inst_structs.rs`
- **实例查询**: `src/rs_surreal/inst.rs`
- **层级查询**: `src/rs_surreal/graph.rs`
- **PE 查询**: `src/rs_surreal/query.rs`
- **查询扩展**: `src/rs_surreal/query_ext.rs`

### 业务模块
- **位号映射**: `src/rs_surreal/tag_name_mapping.rs`
- **测量查询**: `src/rs_surreal/measurement_query.rs`
- **批注查询**: `src/rs_surreal/annotation_query.rs`
- **PBS 查询**: `src/rs_surreal/pbs.rs`
- **MDB 查询**: `src/rs_surreal/mdb.rs`

### 辅助模块
- **布尔查询**: `src/rs_surreal/boolean_query.rs`
- **空间查询**: `src/rs_surreal/spatial.rs`
- **拓扑查询**: `src/rs_surreal/topology.rs`
- **几何查询**: `src/rs_surreal/geometry_query.rs`
