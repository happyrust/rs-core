# AiosDBMgr åˆ° QueryProvider é‡æ„ - é˜¶æ®µä¸€å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. åˆ›å»ºç‹¬ç«‹çš„ MySQL è¿æ¥æ± ç®¡ç†æ¨¡å—

**æ–‡ä»¶**: `src/db_pool/mod.rs`

**åŠŸèƒ½**:
- âœ… æä¾› `get_project_pool()` - è·å–é¡¹ç›®æ•°æ®åº“è¿æ¥æ± 
- âœ… æä¾› `get_global_pool()` - è·å–å…¨å±€é…ç½®æ•°æ®åº“è¿æ¥æ± 
- âœ… æä¾› `get_puhua_pool()` - è·å–æµ¦åå¤–éƒ¨æ•°æ®åº“è¿æ¥æ± 
- âœ… æä¾› `get_project_pools()` - è·å–å¤šé¡¹ç›®è¿æ¥æ± æ˜ å°„
- âœ… æä¾› `default_mysql_conn_str()` å’Œ `puhua_conn_str()` è¾…åŠ©å‡½æ•°

**ç‰¹ç‚¹**:
- ç‹¬ç«‹æ¨¡å—ï¼Œä¸ä¾èµ– AiosDBMgr
- æ¥å— `&DbOption` å‚æ•°ï¼Œé¿å…é™æ€ä¾èµ–
- ä½¿ç”¨ `#[cfg(feature = "sql")]` æ¡ä»¶ç¼–è¯‘

### 2. åˆ›å»ºåŸºäº QueryProvider çš„ PdmsDataInterface å®ç°

**æ–‡ä»¶**: `src/aios_db_mgr/provider_impl.rs`

**æ ¸å¿ƒç»“æ„**:
```rust
pub struct ProviderPdmsInterface {
    provider: Arc<dyn QueryProvider>,
}
```

**å®ç°çš„æ–¹æ³•** (18 ä¸ª):
- âœ… `get_world()` - è·å– World èŠ‚ç‚¹
- âœ… `get_pdms_element()` - è·å– PE å…ƒç´ ï¼ˆä½¿ç”¨ QueryProviderï¼‰
- âœ… `get_attr()` - è·å–å±æ€§ï¼ˆä½¿ç”¨ç°æœ‰å‡½æ•°ï¼‰
- âœ… `get_children()` - è·å–å­èŠ‚ç‚¹ï¼ˆä½¿ç”¨ç°æœ‰å‡½æ•°ï¼‰
- âœ… `get_ipara_from_bran()` - BRAN ç‰¹æ®ŠæŸ¥è¯¢
- âœ… `get_ele_from_name()` - é€šè¿‡åç§°æŸ¥è¯¢
- âœ… `get_spre_attr()` - SPRE å±æ€§
- âœ… `get_catr_attr()` - CATR å±æ€§
- âœ… `get_foreign_attr()` - å¤–é”®å±æ€§
- âœ… `get_name()` - è·å–åç§°
- âœ… `get_world_transform()` - ä¸–ç•Œåæ ‡å˜æ¢
- âœ… `get_prev()` / `get_next()` - åŒçº§èŠ‚ç‚¹
- âœ… `get_room_code()` - æˆ¿é—´å·
- âœ… `query_all_rooms()` - æŸ¥è¯¢æ‰€æœ‰æˆ¿é—´
- âœ… `query_room_elements()` - æŸ¥è¯¢æˆ¿é—´å…ƒç´ 

**è®¾è®¡å†³ç­–**:
- èƒ½ç”¨ `QueryProvider` çš„ä¼˜å…ˆç”¨ï¼ˆå¦‚ `get_pdms_element`ï¼‰
- å¤æ‚ SurrealQL æŸ¥è¯¢æš‚æ—¶ä¿ç•™ç›´æ¥ä½¿ç”¨ `SUL_DB`
- ä½¿ç”¨ç°æœ‰è¾…åŠ©å‡½æ•°ï¼ˆ`get_named_attmap_with_uda`, `get_children_ele_nodes` ç­‰ï¼‰

### 3. æ¨¡å—ç³»ç»Ÿé›†æˆ

**ä¿®æ”¹æ–‡ä»¶**:
- âœ… `src/aios_db_mgr/mod.rs` - æ·»åŠ  `pub mod provider_impl;`
- âœ… `src/lib.rs` - æ·»åŠ  `pub mod db_pool;`

### 4. ç¼–è¯‘éªŒè¯

âœ… **ç¼–è¯‘æˆåŠŸ** - æ— é”™è¯¯ï¼Œæ— æ–°å¢è­¦å‘Š

---

## ğŸ“‹ ä¸‹ä¸€æ­¥ï¼šé˜¶æ®µäºŒ - è¿ç§»ä½¿ç”¨ç‚¹

### éœ€è¦è¿ç§»çš„æ–‡ä»¶ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

#### é«˜ä¼˜å…ˆçº§ï¼šææ–™æ¨¡å—ï¼ˆ8 ä¸ªæ–‡ä»¶ï¼‰

1. **`src/material/dq.rs`** (1 å¤„)
   - æ›¿æ¢ï¼š`AiosDBMgr::get_project_pool()` â†’ `db_pool::get_project_pool(&db_option)`

2. **`src/material/gps.rs`** (1 å¤„)
   - æ›¿æ¢ï¼š`AiosDBMgr::get_project_pool()` â†’ `db_pool::get_project_pool(&db_option)`

3. **`src/material/gy.rs`** (3 å¤„)
   - æ›¿æ¢ï¼š`AiosDBMgr::get_project_pool()` â†’ `db_pool::get_project_pool(&db_option)`

4. **`src/material/nt.rs`** (1 å¤„)
   - æ›¿æ¢ï¼š`AiosDBMgr::get_project_pool()` â†’ `db_pool::get_project_pool(&db_option)`

5. **`src/material/sb.rs`** (1 å¤„)
   - æ›¿æ¢ï¼š`AiosDBMgr::get_project_pool()` â†’ `db_pool::get_project_pool(&db_option)`

6. **`src/material/tf.rs`** (1 å¤„)
   - æ›¿æ¢ï¼š`AiosDBMgr::get_project_pool()` â†’ `db_pool::get_project_pool(&db_option)`

7. **`src/material/tx.rs`** (1 å¤„)
   - æ›¿æ¢ï¼š`AiosDBMgr::get_project_pool()` â†’ `db_pool::get_project_pool(&db_option)`

8. **`src/material/yk.rs`** (3 å¤„)
   - æ›¿æ¢ï¼š`AiosDBMgr::get_project_pool()` â†’ `db_pool::get_project_pool(&db_option)`

#### ä¸­ä¼˜å…ˆçº§ï¼šå…¶ä»– rs-core æ–‡ä»¶

9. **`src/ssc_setting.rs`** (3 å¤„)
   - `AiosDBMgr::init_from_db_option()` â†’ `QueryRouter::surreal_only()`
   - `PdmsDataInterface` ä½¿ç”¨ â†’ `ProviderPdmsInterface`

10. **`src/rs_surreal/datacenter_query.rs`**
    - æ£€æŸ¥æ˜¯å¦å®é™…ä½¿ç”¨ AiosDBMgrï¼Œå¯èƒ½åªæ˜¯å¯¼å…¥æœªä½¿ç”¨

### è¿ç§»æ¨¡æ¿

**ææ–™æ¨¡å—è¿ç§»ç¤ºä¾‹**:
```rust
// æ—§ä»£ç 
let pool = AiosDBMgr::get_project_pool().await?;

// æ–°ä»£ç 
use crate::db_pool;
use crate::get_db_option;

let db_option = get_db_option();
let pool = db_pool::get_project_pool(&db_option).await?;
```

**PdmsDataInterface è¿ç§»ç¤ºä¾‹**:
```rust
// æ—§ä»£ç 
use crate::aios_db_mgr::aios_mgr::AiosDBMgr;
let mgr = AiosDBMgr::init_from_db_option().await?;
let world = mgr.get_world("mdb_name").await?;

// æ–°ä»£ç 
use crate::aios_db_mgr::provider_impl::ProviderPdmsInterface;
use crate::query_provider::QueryRouter;

let provider = QueryRouter::surreal_only();
let interface = ProviderPdmsInterface::new(provider);
let world = interface.get_world("mdb_name").await?;
```

---

## ğŸ¯ é˜¶æ®µä¸‰é¢„è§ˆï¼šgen-model ä»“åº“è¿ç§»

gen-model ä»“åº“éœ€è¦è¿ç§»çš„æ–‡ä»¶ï¼š
- `src/lib.rs`
- `src/versioned_db/database.rs`
- `src/team_data.rs`

è¿ç§»æ–¹å¼ç±»ä¼¼ï¼Œä½†éœ€è¦ç¡®ä¿ aios_core å¯¼å‡ºå¿…è¦çš„å…¬å…± APIã€‚

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **DbOption è·å–**ï¼šææ–™æ¨¡å—éœ€è¦ä¼ å…¥ `&DbOption`ï¼Œå¯ä»¥é€šè¿‡ `get_db_option()` è·å–
2. **ä¸åˆ é™¤æ—§ä»£ç **ï¼šé˜¶æ®µäºŒåªæ·»åŠ æ–°ä»£ç ï¼Œä¸åˆ é™¤ AiosDBMgrï¼Œä¿è¯å›é€€èƒ½åŠ›
3. **é€ä¸ªæ¨¡å—æµ‹è¯•**ï¼šæ¯è¿ç§»ä¸€ä¸ªæ¨¡å—åè¿è¡Œç›¸å…³æµ‹è¯•
4. **ç¡®è®¤ä½¿ç”¨ç‚¹**ï¼šæœ‰äº›æ–‡ä»¶å¯èƒ½åªæ˜¯å¯¼å…¥ä½†æœªå®é™…ä½¿ç”¨ï¼Œéœ€è¦ç¡®è®¤

---

## ğŸ“Š è¿›åº¦ç»Ÿè®¡

- âœ… é˜¶æ®µä¸€ï¼šåˆ›å»ºæ–°æ¨¡å—ï¼ˆ100%ï¼‰
- ğŸ”„ é˜¶æ®µäºŒï¼šè¿ç§»ä½¿ç”¨ç‚¹ï¼ˆ0%ï¼Œå¾…å¼€å§‹ï¼‰
  - ææ–™æ¨¡å—ï¼š0/8
  - å…¶ä»– rs-coreï¼š0/2
- â³ é˜¶æ®µä¸‰ï¼šgen-model è¿ç§»ï¼ˆå¾…å¼€å§‹ï¼‰
- â³ é˜¶æ®µå››ï¼šæ¸…ç†æ—§ä»£ç ï¼ˆå¾…å¼€å§‹ï¼‰

---

## ğŸš€ å¦‚ä½•ç»§ç»­

è¿è¡Œä»¥ä¸‹å‘½ä»¤å¼€å§‹é˜¶æ®µäºŒï¼š

```bash
# æ£€æŸ¥æ‰€æœ‰ææ–™æ¨¡å—çš„ AiosDBMgr ä½¿ç”¨
rg "AiosDBMgr::get_project_pool" src/material/

# å¼€å§‹è¿ç§»ç¬¬ä¸€ä¸ªæ¨¡å—ï¼ˆdq.rsï¼‰
# ç¼–è¾‘ src/material/dq.rs
```

æˆ–è€…ç›´æ¥å‘Šè¯‰æˆ‘ï¼š"ç»§ç»­é˜¶æ®µäºŒï¼Œä»ææ–™æ¨¡å—å¼€å§‹è¿ç§»"ã€‚
