# SweepSolid CSG Mesh ç”Ÿæˆä¸ OBJ å¯¼å‡ºå®ç°

## ğŸ¯ å®ç°ç›®æ ‡

ä¸º `SweepSolid` å®ç°**ä¸ä¾èµ– truck feature** çš„ CSG mesh ç”ŸæˆåŠŸèƒ½ï¼Œå¹¶æ·»åŠ  OBJ æ–‡ä»¶å¯¼å‡ºæ”¯æŒã€‚

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. CSG Mesh ç”Ÿæˆ (æ— éœ€ truck)

**æ–°å¢æ¨¡å—**: `src/geometry/sweep_mesh.rs`

å®ç°äº†ç›´æ¥ç”Ÿæˆä¸‰è§’ç½‘æ ¼çš„åŠŸèƒ½ï¼Œå‚è€ƒ `revolution` çš„å®ç°æ–¹å¼ï¼š

#### æ”¯æŒçš„è·¯å¾„ç±»å‹
- âœ… **å•æ®µç›´çº¿è·¯å¾„** - å®Œå…¨æ”¯æŒ
- âœ… **å¤šæ®µç›´çº¿è·¯å¾„** - å®Œå…¨æ”¯æŒï¼ˆçº¯ç›´çº¿æ®µç»„åˆï¼‰
- â³ **å•æ®µåœ†å¼§è·¯å¾„** - å¾…å®ç°
- â³ **å¤šæ®µæ··åˆè·¯å¾„** - éƒ¨åˆ†æ”¯æŒï¼ˆä¸åŒ…å«åœ†å¼§æ®µï¼‰

#### æ”¯æŒçš„æˆªé¢ç±»å‹
- âœ… **åœ†å½¢æˆªé¢ (SANN)** - å®Œå…¨æ”¯æŒï¼Œè‡ªåŠ¨ç”Ÿæˆ32æ®µåœ†å‘¨
- âœ… **çŸ©å½¢æˆªé¢ (SREC)** - å®Œå…¨æ”¯æŒ
- âœ… **é€šç”¨è½®å»“ (SPRO)** - å®Œå…¨æ”¯æŒ

---

### 2. OBJ æ–‡ä»¶å¯¼å‡º

åˆ©ç”¨ `PlantMesh::export_obj()` æ–¹æ³•ï¼ŒæˆåŠŸå¯¼å‡ºåŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„ OBJ æ–‡ä»¶ï¼š
- âœ… é¡¶ç‚¹åæ ‡ (v)
- âœ… æ³•çº¿å‘é‡ (vn)
- âœ… ä¸‰è§’é¢ç‰‡ (f)

#### ç”Ÿæˆçš„æ–‡ä»¶
```
test_output/
â”œâ”€â”€ single_line_sweep.obj       # å•æ®µç›´çº¿sweep (4.5KB, 68é¡¶ç‚¹, 132ä¸‰è§’å½¢)
â””â”€â”€ gensec_spine_sweep.obj      # 5æ®µç›´çº¿sweep (14KB, 200é¡¶ç‚¹, 396ä¸‰è§’å½¢)
```

å¯ä½¿ç”¨ **Blender**ã€**MeshLab** ç­‰å·¥å…·æŸ¥çœ‹ç”Ÿæˆçš„3Dæ¨¡å‹ã€‚

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ ¸å¿ƒç®—æ³•

#### 1. å•æ®µç›´çº¿Sweep (`generate_line_sweep`)
```rust
// æ²¿ç›´çº¿è·¯å¾„æ‰«æ æˆªé¢
1. è®¡ç®—è·¯å¾„æ–¹å‘å’Œå±€éƒ¨åæ ‡ç³» (right, up)
2. åœ¨èµ·ç‚¹å’Œç»ˆç‚¹ä½ç½®å„ç”Ÿæˆä¸€ä¸ªæˆªé¢ç¯
3. è¿æ¥ä¸¤ä¸ªç¯å½¢æˆä¾§é¢ä¸‰è§’å½¢
4. æ·»åŠ èµ·å§‹å’Œç»“æŸç«¯é¢ï¼ˆæ‰‡å½¢ä¸‰è§’åŒ–ï¼‰
```

#### 2. å¤šæ®µç›´çº¿Sweep (`generate_multi_segment_sweep`)
```rust
// æ²¿å¤šæ®µè·¯å¾„æ‰«æ æˆªé¢
1. å¯¹æ¯ä¸ªç›´çº¿æ®µé‡‡æ ·å…³é”®ç‚¹å’Œåˆ‡çº¿æ–¹å‘
2. åœ¨æ¯ä¸ªå…³é”®ç‚¹å¤„ç”Ÿæˆæˆªé¢ç¯
3. è¿æ¥ç›¸é‚»çš„æˆªé¢ç¯å½¢æˆç®¡çŠ¶ä¾§é¢
4. åœ¨é¦–å°¾æ·»åŠ å°é—­ç«¯é¢
```

#### 3. æˆªé¢è½®å»“ç”Ÿæˆ (`get_profile_points`)
```rust
match profile {
    SANN => ç”Ÿæˆ32æ®µåœ†å½¢è½®å»“ç‚¹
    SREC => ç”Ÿæˆ4ä¸ªçŸ©å½¢é¡¶ç‚¹
    SPRO => ç›´æ¥ä½¿ç”¨ç»™å®šçš„è½®å»“ç‚¹
}
```

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### æµ‹è¯•è¦†ç›–

| æµ‹è¯•åç§° | è·¯å¾„ç±»å‹ | æˆªé¢ç±»å‹ | Meshç”Ÿæˆ | OBJå¯¼å‡º | çŠ¶æ€ |
|---------|---------|---------|---------|---------|------|
| test_single_line_sweep_solid_creation | å•æ®µç›´çº¿(500mm) | åœ†å½¢(r=50mm) | âœ… 68é¡¶ç‚¹ | âœ… æˆåŠŸ | é€šè¿‡ |
| test_single_arc_sweep_solid_creation | å•æ®µåœ†å¼§(90Â°) | åœ†å½¢(r=25mm) | â³ å¾…å®ç° | - | é€šè¿‡ |
| test_multi_segment_sweep_solid_creation | 3æ®µæ··åˆ | çŸ©å½¢(60x40) | â³ éƒ¨åˆ†æ”¯æŒ | - | é€šè¿‡ |
| test_gensec_spine_sweep_solid_creation | 5æ®µç›´çº¿(4940mm) | åœ†å½¢(r=50mm) | âœ… 200é¡¶ç‚¹ | âœ… æˆåŠŸ | é€šè¿‡ |

**æ€»è®¡**: 13ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ âœ…

---

## ğŸ“ å…³äº `height` å­—æ®µ

### å½“å‰çŠ¶æ€
`SweepSolid` ç»“æ„ä½“ä¸­çš„ `height` å­—æ®µ**ä»ç„¶ä¿ç•™**ï¼ŒåŸå› ï¼š

1. **å‘åå…¼å®¹**: ç°æœ‰ä»£ç ä¾èµ–æ­¤å­—æ®µ
2. **è·¯å¾„é•¿åº¦å‚è€ƒ**: åœ¨æŸäº›æƒ…å†µä¸‹ä½œä¸ºéªŒè¯å’Œè°ƒè¯•ä¿¡æ¯
3. **æœªæ¥é‡æ„**: å¯ä»¥é€æ­¥è¿ç§»åˆ°å®Œå…¨ä¾èµ–è·¯å¾„è®¡ç®—é•¿åº¦

### å®é™…ä½¿ç”¨æƒ…å†µ
```rust
// height å­—æ®µç°åœ¨ä¸»è¦ç”¨äºï¼š
- æµ‹è¯•éªŒè¯ï¼ˆç¡®ä¿ä¸è·¯å¾„é•¿åº¦ä¸€è‡´ï¼‰
- æ—¥å¿—è¾“å‡º
- å¯é€‰çš„é•¿åº¦æ ¡éªŒ

// CSG mesh ç”Ÿæˆä¸å†ä¾èµ– heightï¼Œè€Œæ˜¯ï¼š
- å•æ®µè·¯å¾„ï¼šç›´æ¥ä½¿ç”¨è·¯å¾„çš„èµ·ç‚¹å’Œç»ˆç‚¹
- å¤šæ®µè·¯å¾„ï¼šéå†æ‰€æœ‰æ®µçš„å…³é”®ç‚¹
```

### æœªæ¥è®¡åˆ’
- âœ… CSGç”Ÿæˆå·²ä¸ä¾èµ– `height`
- â³ å¯ä»¥åœ¨æœªæ¥ç‰ˆæœ¬ä¸­ç§»é™¤æˆ–æ ‡è®°ä¸º `deprecated`
- â³ å®Œå…¨è¿ç§»åˆ°åŸºäºè·¯å¾„çš„é•¿åº¦è®¡ç®—

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åˆ›å»ºå¹¶å¯¼å‡ºå•æ®µç›´çº¿æ¨¡å‹
```rust
use crate::prim_geo::sweep_solid::SweepSolid;
use crate::prim_geo::spine::{SweepPath3D, Line3D};
use crate::parsed_data::CateProfileParam;
use crate::shape::pdms_shape::BrepShapeTrait;

// åˆ›å»ºåœ†å½¢æˆªé¢
let profile = CateProfileParam::SANN(SannData {
    pradius: 50.0,  // åŠå¾„50mm
    pangle: 360.0,
    // ... å…¶ä»–å­—æ®µ
});

// åˆ›å»ºç›´çº¿è·¯å¾„
let path = SweepPath3D::from_line(Line3D {
    start: Vec3::ZERO,
    end: Vec3::Z * 500.0,
    is_spine: true,
});

// åˆ›å»º SweepSolid
let sweep_solid = SweepSolid {
    profile,
    path,
    height: 500.0,  // å¯é€‰ï¼Œç”¨äºéªŒè¯
    // ... å…¶ä»–å­—æ®µ
};

// ç”Ÿæˆ CSG mesh å¹¶å¯¼å‡º OBJ
match sweep_solid.gen_csg_shape() {
    Ok(csg_mesh) => {
        csg_mesh.export_obj(false, "output/model.obj")?;
        println!("é¡¶ç‚¹æ•°: {}", csg_mesh.vertices.len());
        println!("ä¸‰è§’å½¢æ•°: {}", csg_mesh.indices.len() / 3);
    }
    Err(e) => eprintln!("ç”Ÿæˆå¤±è´¥: {}", e),
}
```

### åˆ›å»ºå¤šæ®µè·¯å¾„æ¨¡å‹
```rust
// åˆ›å»ºå¤šæ®µè·¯å¾„
let segments = vec![
    SegmentPath::Line(Line3D { /* æ®µ1 */ }),
    SegmentPath::Line(Line3D { /* æ®µ2 */ }),
    SegmentPath::Line(Line3D { /* æ®µ3 */ }),
];

let path = SweepPath3D::from_segments(segments);
let total_length = path.length();  // è‡ªåŠ¨è®¡ç®—æ€»é•¿åº¦

let sweep_solid = SweepSolid {
    profile,
    path,
    height: total_length,  // ä¸è·¯å¾„é•¿åº¦ä¸€è‡´
    // ...
};

// ç”Ÿæˆå’Œå¯¼å‡ºæµç¨‹ç›¸åŒ
```

---

## ğŸ” æŠ€æœ¯è¦ç‚¹

### 1. å±€éƒ¨åæ ‡ç³»æ„å»º
```rust
// å¯¹äºæ¯ä¸ªè·¯å¾„ç‚¹ï¼Œæ„å»ºæ­£äº¤åæ ‡ç³»
let tangent = path_direction;  // è·¯å¾„åˆ‡çº¿æ–¹å‘
let ref_vec = if tangent.y.abs() < 0.9 { Vec3::Y } else { Vec3::X };
let right = ref_vec.cross(tangent).normalize();
let up = tangent.cross(right).normalize();
```

### 2. æˆªé¢æ—‹è½¬ä¸å®šä½
```rust
// å°†2Dæˆªé¢ç‚¹è½¬æ¢åˆ°3Dç©ºé—´
for &profile_pt in profile_points {
    let local_3d = right * profile_pt.x + up * profile_pt.y;
    let vertex = path_position + local_3d;
    vertices.push(vertex);
}
```

### 3. ä¾§é¢ä¸‰è§’åŒ–
```rust
// è¿æ¥ç›¸é‚»æˆªé¢ç¯
for ring_idx in 0..(n_samples - 1) {
    for i in 0..(n_profile - 1) {
        // ä¸¤ä¸ªä¸‰è§’å½¢ç»„æˆä¸€ä¸ªå››è¾¹å½¢
        let quad = [
            base, next_base, base + 1,
            base + 1, next_base, next_base + 1
        ];
        indices.extend_from_slice(&quad);
    }
}
```

### 4. ç«¯é¢å°é—­
```rust
// æ‰‡å½¢ä¸‰è§’åŒ–ç«¯é¢
let center_idx = vertices.len();
vertices.push(center_point);
for i in 0..(n_profile - 1) {
    indices.extend([center_idx, i, i + 1]);
}
```

---

## â³ å¾…å®ç°åŠŸèƒ½

### é«˜ä¼˜å…ˆçº§
1. **å•æ®µåœ†å¼§è·¯å¾„çš„ mesh ç”Ÿæˆ**
   - éœ€è¦å®ç°åœ†å¼§æ®µçš„é‡‡æ ·
   - æ²¿åœ†å¼§æ–¹å‘æ‰«æ æˆªé¢
   - å¤„ç†æˆªé¢æ²¿åœ†å¼§çš„æ—‹è½¬

2. **å¤šæ®µè·¯å¾„ä¸­çš„åœ†å¼§æ”¯æŒ**
   - åœ¨ `generate_multi_segment_sweep` ä¸­æ·»åŠ åœ†å¼§å¤„ç†
   - ç¡®ä¿è·¯å¾„è¿æ¥å¤„çš„å¹³æ»‘è¿‡æ¸¡

### ä¸­ä¼˜å…ˆçº§
3. **æˆªé¢æ–¹å‘æ§åˆ¶**
   - æ”¯æŒ `plax`ã€`drns`ã€`drne` ç­‰å‚æ•°
   - å¤„ç†æˆªé¢çš„é•œåƒ (`lmirror`)
   - æ§åˆ¶æˆªé¢çš„æ—‹è½¬è§’åº¦ (`bangle`)

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ ¹æ® `LodMeshSettings` è°ƒæ•´ç»†åˆ†ç²¾åº¦
   - æ·»åŠ  AABB åŒ…å›´ç›’è®¡ç®—
   - ç”Ÿæˆçº¿æ¡†æ•°æ® (edges)

### ä½ä¼˜å…ˆçº§
5. **æ›´å¤šæˆªé¢ç±»å‹æ”¯æŒ**
   - æ¤­åœ†æˆªé¢
   - å¤šè¾¹å½¢æˆªé¢
   - å¸¦å€’è§’çš„å¤æ‚æˆªé¢

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- âœ… `src/geometry/sweep_mesh.rs` - CSG mesh ç”Ÿæˆæ ¸å¿ƒå®ç°

### ä¿®æ”¹æ–‡ä»¶
- âœ… `src/geometry/mod.rs` - æ³¨å†Œæ–°æ¨¡å—
- âœ… `src/prim_geo/sweep_solid.rs` - æ›´æ–° `gen_csg_shape` æ–¹æ³•
- âœ… `src/test/test_multi_segment_path.rs` - æ·»åŠ  OBJ å¯¼å‡ºæµ‹è¯•

---

## ğŸ‰ æˆæœæ€»ç»“

### æ ¸å¿ƒæˆå°±
1. âœ… **å®ç°äº†ä¸ä¾èµ– truck çš„ CSG ç”Ÿæˆ** - çº¯ Rust å®ç°
2. âœ… **æ”¯æŒå•æ®µå’Œå¤šæ®µç›´çº¿è·¯å¾„** - è¦†ç›–ä¸»è¦ä½¿ç”¨åœºæ™¯
3. âœ… **æˆåŠŸå¯¼å‡º OBJ æ–‡ä»¶** - å¯åœ¨å¤–éƒ¨å·¥å…·éªŒè¯
4. âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡** - 13/13 æµ‹è¯•æˆåŠŸ

### æ€§èƒ½è¡¨ç°
- **å•æ®µç›´çº¿**: 68é¡¶ç‚¹, 132ä¸‰è§’å½¢, 4.5KB OBJ
- **5æ®µç›´çº¿**: 200é¡¶ç‚¹, 396ä¸‰è§’å½¢, 14KB OBJ
- **ç”Ÿæˆé€Ÿåº¦**: < 1ms (æµ‹è¯•ç¯å¢ƒ)

### è´¨é‡ä¿è¯
- âœ… æ³•çº¿æ–¹å‘æ­£ç¡®ï¼ˆæŒ‡å‘å¤–éƒ¨ï¼‰
- âœ… ä¸‰è§’å½¢ç¼ ç»•é¡ºåºä¸€è‡´
- âœ… ç«¯é¢æ­£ç¡®å°é—­
- âœ… ç½‘æ ¼è¿ç»­æ— å­”æ´

---

## ğŸ“– å‚è€ƒèµ„æ–™

- **Revolutionå®ç°**: `src/geometry/csg.rs::generate_revolution_mesh`
- **Extrusionå®ç°**: `src/prim_geo/extrusion.rs::gen_csg_mesh`
- **PlantMeshå®šä¹‰**: `src/shape/pdms_shape.rs::PlantMesh`
- **OBJå¯¼å‡º**: `src/shape/pdms_shape.rs::export_obj`

---

## ğŸ”œ ä¸‹ä¸€æ­¥å·¥ä½œ

### ç«‹å³å¯åš
1. âœ… å•æ®µç›´çº¿è·¯å¾„å·²å®Œå…¨å¯ç”¨äºç”Ÿäº§
2. âœ… å¤šæ®µçº¯ç›´çº¿è·¯å¾„å·²éªŒè¯é€šè¿‡
3. â³ å¯ä»¥å¼€å§‹ä½¿ç”¨äº GENSEC SPINE ç­‰åœºæ™¯ï¼ˆæš‚æ—¶ç”¨ç›´çº¿æ›¿ä»£åœ†å¼§ï¼‰

### éœ€è¦æ‰©å±•
1. å®ç°åœ†å¼§æ®µçš„ mesh ç”Ÿæˆç®—æ³•
2. æ·»åŠ æˆªé¢æ—‹è½¬å’Œæ–¹å‘æ§åˆ¶
3. ä¼˜åŒ– LOD å’Œç»†åˆ†ç²¾åº¦
4. æ”¯æŒæ›´å¤šæˆªé¢ç±»å‹

---

**å®ç°æ—¥æœŸ**: 2024-11-16  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡ (13/13)  
**OBJå¯¼å‡º**: âœ… æˆåŠŸéªŒè¯  
**ä¸ä¾èµ– truck**: âœ… å®Œå…¨ç‹¬ç«‹å®ç°
