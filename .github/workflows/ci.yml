name: CI

on:
  push:
    branches: [ "master", "main", "dev" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:  # 允许手动触发

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # 代码检查和格式化
  check:
    name: Check & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
        continue-on-error: true  # clippy 失败不阻止流程

  # 构建测试
  build:
    name: Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        features:
          - ""  # 默认特性
          - "bevy_transform,bevy_math,bevy_ecs,bevy_reflect"
          - "sqlite"
          - "gen_model"
        exclude:
          # gen_model 依赖 manifold-sys，仅在 Linux 上测试
          - os: windows-latest
            features: "gen_model"
          - os: macos-latest
            features: "gen_model"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      # 修复 Cargo.toml 中的本地路径依赖
      - name: Fix local path dependencies
        shell: bash
        run: |
          # 移除指向本地路径的 patch
          if grep -q '\[patch\."https://gitee.com/happydpc/surrealdb"\]' Cargo.toml; then
            sed -i.bak '/\[patch\."https:\/\/gitee.com\/happydpc\/surrealdb"\]/,/^$/d' Cargo.toml
          fi
          
          # 如果有本地 ploop-rs 依赖，改为 git 依赖
          if grep -q 'ploop-rs.*path.*=' Cargo.toml; then
            sed -i.bak 's|ploop-rs = { path = "../rust-ploop-processor/ploop-rs" }|# ploop-rs = { git = "https://gitee.com/happydpc/rust-ploop-processor.git", branch = "dev", package = "ploop-rs" }|' Cargo.toml
          fi
      
      # Linux 特定依赖
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev
      
      - name: Build
        run: |
          if [ -n "${{ matrix.features }}" ]; then
            cargo build --verbose --features "${{ matrix.features }}"
          else
            cargo build --verbose
          fi
        shell: bash
      
      - name: Run tests
        run: |
          if [ -n "${{ matrix.features }}" ]; then
            cargo test --verbose --features "${{ matrix.features }}" --lib
          else
            cargo test --verbose --lib
          fi
        shell: bash
        continue-on-error: true  # 测试失败不阻止流程

  # 文档生成
  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      
      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Fix local dependencies
        run: |
          sed -i.bak '/\[patch\."https:\/\/gitee.com\/happydpc\/surrealdb"\]/,/^$/d' Cargo.toml
      
      - name: Generate documentation
        run: cargo doc --no-deps --all-features
        env:
          RUSTDOCFLAGS: "-D warnings"
      
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc
          cname: rs-core-docs.example.com  # 可选：自定义域名

  # 性能基准测试
  benchmark:
    name: Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      
      - name: Fix local dependencies
        run: |
          sed -i.bak '/\[patch\."https:\/\/gitee.com\/happydpc\/surrealdb"\]/,/^$/d' Cargo.toml
      
      - name: Run benchmarks
        run: cargo bench --bench room_query_bench
        continue-on-error: true

  # 安全审计
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run cargo-audit
        uses: rustsec/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true  # 安全问题不阻止构建

  # 发布检查
  publish-check:
    name: Publish Check
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
      
      - name: Fix local dependencies
        run: |
          sed -i.bak '/\[patch\."https:\/\/gitee.com\/happydpc\/surrealdb"\]/,/^$/d' Cargo.toml
      
      - name: Dry run publish
        run: cargo publish --dry-run
        continue-on-error: true
