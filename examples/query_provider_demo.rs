//! æŸ¥è¯¢æä¾›è€…ä½¿ç”¨ç¤ºä¾‹
//!
//! æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢
//!
//! è¿è¡Œæ–¹å¼:
//! ```bash
//! cargo run --example query_provider_demo --features kuzu
//! ```

use aios_core::query_provider::*;
use aios_core::{init_surreal, RefnoEnum};
use anyhow::Result;

#[tokio::main]
async fn main() -> Result<()> {
    // åˆå§‹åŒ–æ—¥å¿—
    env_logger::Builder::from_env(env_logger::Env::default().default_filter_or("info")).init();

    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘         ç»Ÿä¸€æŸ¥è¯¢æ¥å£ä½¿ç”¨ç¤ºä¾‹                          â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    // åˆå§‹åŒ–æ•°æ®åº“
    println!("ğŸ“¦ åˆå§‹åŒ– SurrealDB...");
    init_surreal().await?;
    println!("âœ… SurrealDB åˆå§‹åŒ–å®Œæˆ\n");

    // ========================================================================
    // ç¤ºä¾‹ 1: ä½¿ç”¨ SurrealDB æŸ¥è¯¢æä¾›è€…
    // ========================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ç¤ºä¾‹ 1: ç›´æ¥ä½¿ç”¨ SurrealDB æŸ¥è¯¢æä¾›è€…");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let surreal_provider = SurrealQueryProvider::new()?;
    println!("æä¾›è€…åç§°: {}", surreal_provider.provider_name());

    // æŸ¥è¯¢æ‰€æœ‰ PIPE å…ƒç´ 
    let pipes = surreal_provider.query_by_type(&["PIPE"], 1112, None).await?;
    println!("âœ“ æŸ¥è¯¢åˆ° {} ä¸ª PIPE å…ƒç´ ", pipes.len());

    // è·å–ç¬¬ä¸€ä¸ª PIPE çš„å­èŠ‚ç‚¹
    if let Some(&first_pipe) = pipes.first() {
        let children = surreal_provider.get_children(first_pipe).await?;
        println!("âœ“ ç¬¬ä¸€ä¸ª PIPE æœ‰ {} ä¸ªå­èŠ‚ç‚¹", children.len());

        // æŸ¥è¯¢æ·±å±‚å­å­™ï¼ˆ3å±‚ï¼‰
        let descendants = surreal_provider
            .get_descendants(first_pipe, Some(3))
            .await?;
        println!("âœ“ æ·±åº¦3çš„å­å­™èŠ‚ç‚¹: {} ä¸ª\n", descendants.len());
    }

    // ========================================================================
    // ç¤ºä¾‹ 2: ä½¿ç”¨ Kuzu æŸ¥è¯¢æä¾›è€…ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    // ========================================================================
    #[cfg(feature = "kuzu")]
    {
        println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
        println!("ç¤ºä¾‹ 2: ç›´æ¥ä½¿ç”¨ Kuzu æŸ¥è¯¢æä¾›è€…");
        println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

        match KuzuQueryProvider::new() {
            Ok(kuzu_provider) => {
                println!("æä¾›è€…åç§°: {}", kuzu_provider.provider_name());

                // åŒæ ·çš„æŸ¥è¯¢ï¼Œä½†ä½¿ç”¨ Kuzu
                let pipes = kuzu_provider.query_by_type(&["PIPE"], 1112, None).await?;
                println!("âœ“ æŸ¥è¯¢åˆ° {} ä¸ª PIPE å…ƒç´ ", pipes.len());

                // å¥åº·æ£€æŸ¥
                let health = kuzu_provider.health_check().await?;
                println!("âœ“ Kuzu å¥åº·çŠ¶æ€: {}\n", if health { "æ­£å¸¸" } else { "å¼‚å¸¸" });
            }
            Err(e) => {
                println!("âš ï¸  Kuzu æä¾›è€…ä¸å¯ç”¨: {}\n", e);
            }
        }
    }

    // ========================================================================
    // ç¤ºä¾‹ 3: ä½¿ç”¨æŸ¥è¯¢è·¯ç”±å™¨ - è‡ªåŠ¨é€‰æ‹©æ¨¡å¼
    // ========================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ç¤ºä¾‹ 3: ä½¿ç”¨æŸ¥è¯¢è·¯ç”±å™¨ï¼ˆè‡ªåŠ¨é€‰æ‹©æ¨¡å¼ï¼‰");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    // åˆ›å»ºè‡ªåŠ¨é€‰æ‹©ç­–ç•¥çš„è·¯ç”±å™¨
    let router = QueryRouter::auto()?;
    println!("è·¯ç”±å™¨: {}", router.provider_name());
    println!("ç­–ç•¥: {:?}\n", router.get_strategy().engine);

    // ä½¿ç”¨è·¯ç”±å™¨è¿›è¡ŒæŸ¥è¯¢ - æ¥å£å®Œå…¨ç›¸åŒï¼
    let zones = router.query_by_type(&["ZONE"], 1112, None).await?;
    println!("âœ“ æŸ¥è¯¢åˆ° {} ä¸ª ZONE å…ƒç´ ", zones.len());

    if let Some(&first_zone) = zones.first() {
        // è·å–ç›´æ¥å­èŠ‚ç‚¹
        let children = router.get_children(first_zone).await?;
        println!("âœ“ ç¬¬ä¸€ä¸ª ZONE æœ‰ {} ä¸ªå­èŠ‚ç‚¹", children.len());

        // è¿‡æ»¤æ·±å±‚å­èŠ‚ç‚¹ï¼ˆåªè¦ PIPE å’Œ EQUIï¼‰
        let filtered = router
            .get_descendants_filtered(first_zone, &["PIPE", "EQUI"], Some(5))
            .await?;
        println!("âœ“ è¿‡æ»¤åçš„å­å­™èŠ‚ç‚¹ï¼ˆPIPE+EQUIï¼‰: {} ä¸ª\n", filtered.len());
    }

    // ========================================================================
    // ç¤ºä¾‹ 4: åŠ¨æ€åˆ‡æ¢æŸ¥è¯¢ç­–ç•¥
    // ========================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ç¤ºä¾‹ 4: åŠ¨æ€åˆ‡æ¢æŸ¥è¯¢ç­–ç•¥");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let router = QueryRouter::auto()?;

    // ä½¿ç”¨ SurrealDB ç­–ç•¥
    router.set_strategy(QueryStrategy::surreal_only());
    println!("åˆ‡æ¢åˆ° SurrealDB æ¨¡å¼");

    let equis = router.query_by_type(&["EQUI"], 1112, None).await?;
    println!("âœ“ æŸ¥è¯¢åˆ° {} ä¸ª EQUI å…ƒç´ ", equis.len());

    // åˆ‡æ¢å›è‡ªåŠ¨æ¨¡å¼
    router.set_strategy(QueryStrategy::auto());
    println!("âœ“ åˆ‡æ¢å›è‡ªåŠ¨é€‰æ‹©æ¨¡å¼\n");

    // ========================================================================
    // ç¤ºä¾‹ 5: æ‰¹é‡æŸ¥è¯¢
    // ========================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ç¤ºä¾‹ 5: æ‰¹é‡æŸ¥è¯¢");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let router = QueryRouter::auto()?;

    // è·å–ä¸€äº› refno
    let test_refnos: Vec<RefnoEnum> = zones.iter().take(3).copied().collect();

    // æ‰¹é‡è·å–å­èŠ‚ç‚¹
    let all_children = router.get_children_batch(&test_refnos).await?;
    println!("âœ“ {} ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹: {} ä¸ª", test_refnos.len(), all_children.len());

    // æ‰¹é‡è·å– PE ä¿¡æ¯
    let pes = router.get_pes_batch(&test_refnos).await?;
    println!("âœ“ æ‰¹é‡è·å– {} ä¸ª PE ä¿¡æ¯", pes.len());

    // æ‰¹é‡è·å–å…¨å
    let full_names = router.get_full_names_batch(&test_refnos).await?;
    println!("âœ“ æ‰¹é‡è·å– {} ä¸ªå…¨å\n", full_names.len());

    // ========================================================================
    // ç¤ºä¾‹ 6: å›¾éå†æŸ¥è¯¢
    // ========================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ç¤ºä¾‹ 6: å›¾éå†æŸ¥è¯¢");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let router = QueryRouter::auto()?;

    if let Some(&zone_refno) = zones.first() {
        // è·å–èŠ‚ç‚¹æ·±åº¦
        let depth = router.get_node_depth(zone_refno).await?;
        println!("âœ“ ZONE èŠ‚ç‚¹æ·±åº¦: {}", depth);

        // æŸ¥è¯¢ç¥–å…ˆ
        let ancestors = router.get_ancestors(zone_refno).await?;
        println!("âœ“ ç¥–å…ˆèŠ‚ç‚¹æ•°é‡: {}", ancestors.len());

        // æŸ¥è¯¢ç‰¹å®šç±»å‹çš„ç¥–å…ˆ
        let site_ancestors = router
            .get_ancestors_of_type(zone_refno, &["SITE", "WORLD"])
            .await?;
        println!("âœ“ SITE/WORLD ç¥–å…ˆ: {} ä¸ª\n", site_ancestors.len());
    }

    // ========================================================================
    // ç¤ºä¾‹ 7: è‡ªå®šä¹‰ç­–ç•¥é…ç½®
    // ========================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ç¤ºä¾‹ 7: è‡ªå®šä¹‰ç­–ç•¥é…ç½®");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    // åˆ›å»ºè‡ªå®šä¹‰ç­–ç•¥
    let custom_strategy = QueryStrategy {
        engine: QueryEngine::Auto,
        enable_fallback: true,
        timeout_ms: Some(3000),
        enable_performance_log: true,
    };

    let router = QueryRouter::new(custom_strategy)?;
    println!("âœ“ åˆ›å»ºè‡ªå®šä¹‰ç­–ç•¥è·¯ç”±å™¨");
    println!("  - å¼•æ“: Auto");
    println!("  - å›é€€: å¯ç”¨");
    println!("  - è¶…æ—¶: 3000ms");
    println!("  - æ€§èƒ½æ—¥å¿—: å¯ç”¨\n");

    // æ‰§è¡ŒæŸ¥è¯¢ï¼ˆä¼šè‡ªåŠ¨è®°å½•æ€§èƒ½ï¼‰
    let _result = router.query_by_type(&["PIPE"], 1112, None).await?;

    // ========================================================================
    // æ€»ç»“
    // ========================================================================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("æ€»ç»“");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("âœ… ç»Ÿä¸€æŸ¥è¯¢æ¥å£çš„ä¼˜åŠ¿:");
    println!("  1. åŒä¸€å¥— APIï¼Œå¤šç§æ•°æ®åº“å®ç°");
    println!("  2. è½»æ¾åˆ‡æ¢æŸ¥è¯¢å¼•æ“ï¼Œæ— éœ€ä¿®æ”¹ä¸šåŠ¡ä»£ç ");
    println!("  3. è‡ªåŠ¨å›é€€æœºåˆ¶ï¼Œæé«˜ç³»ç»Ÿå¯é æ€§");
    println!("  4. æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—ï¼Œä¾¿äºè°ƒä¼˜");
    println!("  5. ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥");

    println!("\nâœ… æ¨èä½¿ç”¨æ–¹å¼:");
    println!("  - å¼€å‘é˜¶æ®µ: ä½¿ç”¨ Auto æ¨¡å¼ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å¼•æ“");
    println!("  - ç”Ÿäº§ç¯å¢ƒ: æ ¹æ®å®é™…æ€§èƒ½æµ‹è¯•ç»“æœé€‰æ‹©å›ºå®šå¼•æ“");
    println!("  - æ•…éšœæ¢å¤: å¯ç”¨ fallbackï¼Œç¡®ä¿æœåŠ¡å¯ç”¨æ€§");

    println!("\nğŸ‰ æ¼”ç¤ºå®Œæˆï¼");

    Ok(())
}
