# BEND 24381/46958 调试分析

## 问题描述

BEND 24381/46958 的模型生成有问题，所有的 SSL (SSLC) 几何体都生成为默认的 PrimSCylinder：
```rust
PrimSCylinder: { 
    btm_shear_angles: [0, 0], 
    center_in_mid: false, 
    negative: false, 
    paxi_dir: [0, 0, 1], 
    paxi_expr: 'Z', 
    paxi_pt: [0, 0, 0], 
    pdia: 1, 
    phei: 1, 
    top_shear_angles: [0, 0], 
    unit_flag: true 
}
```

显然这些参数都是默认值，没有从数据库中正确读取。

## 数据流分析

### 1. 数据库查询路径

BEND 弯头应该包含多个 SSL 子元素，每个 SSL 代表弯头的一段圆柱体。

查询路径：
1. `query_gm_params(bend_refno)` - 查询 BEND 的几何参数
2. `collect_descendant_full_attrs(&[refno], &TOTAL_CATA_GEO_NOUN_NAMES, Some("1..2"))` - 查询子孙节点
3. 应该返回多个 SSLC (SSL) 类型的几何元素

### 2. 几何参数转换路径

```
NamedAttrMap (数据库) 
  -> GmParam (查询结构)
  -> GmseParamData (解析后)
  -> CateSlopeBottomCylinderParam (分类参数)
  -> SCylinder (最终几何体)
```

### 3. Shear Angles 映射

数据库属性 -> GmParam.shears:
- shears[0] = PXTS (Top X Shear)
- shears[1] = PYTS (Top Y Shear)
- shears[2] = PXBS (Bottom X Shear)
- shears[3] = PYBS (Bottom Y Shear)

CateSlopeBottomCylinderParam:
- x_shear = shears[0] (PXTS)
- y_shear = shears[1] (PYTS)
- alt_x_shear = shears[2] (PXBS)
- alt_y_shear = shears[3] (PYBS)

SCylinder:
- btm_shear_angles = [alt_x_shear, alt_y_shear] = [PXBS, PYBS]
- top_shear_angles = [x_shear, y_shear] = [PXTS, PYTS]

## 可能的问题

### 1. 数据库中没有 SSL 子元素

BEND 可能没有正确的 SSL 子元素，或者查询条件不对。

需要检查：
- BEND 24381/46958 是否有 SSL 子元素
- SSL 的 noun 类型是 "SSLC" 还是 "SSL"
- 子元素的层级关系（是直接子元素还是孙子元素）

### 2. SSL 属性数据缺失

SSL 子元素可能存在，但是缺少关键属性：
- PXTS, PYTS, PXBS, PYBS (shear angles)
- PDIA (diameter)
- PHEI (height)
- PAXI (axis)
- PDIS (distance to bottom)

### 3. 几何参数解析失败

在 `resolve_helper.rs` 中，SSLC 的解析有条件检查：
```rust
"SSLC" | "NSSL" => {
    if gmse.paxises.len() >= 1 && gmse.diameters.len() >= 1 && gmse.shears.len() >= 4 {
        // 正常解析
    } else {
        CateGeoParam::Unknown  // 返回 Unknown！
    }
}
```

如果 shears.len() < 4，会返回 Unknown，导致几何体无法生成。

## 调试步骤

### 1. 查询 BEND 的子元素

```sql
-- SurrealDB 查询
SELECT * FROM pe WHERE id IN (
    SELECT VALUE in FROM pe:⟨24381_46958⟩<-pe_owner
) AND noun IN ['SSL', 'SSLC', 'SCYL'];
```

### 2. 查询 SSL 的属性

```sql
-- 查询第一个 SSL 的完整属性
SELECT * FROM (
    SELECT VALUE in FROM pe:⟨24381_46958⟩<-pe_owner WHERE in.noun IN ['SSL', 'SSLC']
)[0].refno;
```

### 3. 检查 shear angles

```sql
SELECT 
    id,
    refno.PXTS as top_x_shear,
    refno.PYTS as top_y_shear,
    refno.PXBS as btm_x_shear,
    refno.PYBS as btm_y_shear,
    refno.PDIA as diameter,
    refno.PHEI as height
FROM (
    SELECT VALUE in FROM pe:⟨24381_46958⟩<-pe_owner WHERE in.noun IN ['SSL', 'SSLC']
);
```

## 解决方案

根据问题原因，可能的解决方案：

### 方案 1: 修复数据查询

如果 SSL 子元素存在但查询不到，需要修改查询条件：
- 检查 noun 类型（可能是 "SSL" 而不是 "SSLC"）
- 检查查询深度（可能需要查询更深层级）

### 方案 2: 修复属性解析

如果属性数据存在但解析失败，需要：
- 检查属性名称映射是否正确
- 添加调试日志输出 shears 数组的长度和内容
- 检查表达式求值是否正确

### 方案 3: 添加默认值处理

如果某些 SSL 确实缺少 shear angles，可以：
- 为缺失的 shear angles 提供默认值 0.0
- 修改条件检查，允许部分属性缺失

## 下一步

1. 先查询数据库，确认 BEND 24381/46958 的子元素结构
2. 检查 SSL 子元素的属性数据是否完整
3. 根据实际情况选择合适的修复方案

## 数据库调试查询

### 查询 1: 检查 BEND 的子元素

```sql
-- 查询 BEND 24381/46958 的所有子元素
SELECT
    id,
    refno,
    noun,
    name
FROM (
    SELECT VALUE in FROM pe:⟨24381_46958⟩<-pe_owner
)
ORDER BY noun, refno;
```

### 查询 2: 检查 SSLC 子元素的属性

```sql
-- 查询 BEND 下的所有 SSLC 子元素及其关键属性
SELECT
    id,
    refno,
    noun,
    refno.PXTS as top_x_shear,
    refno.PYTS as top_y_shear,
    refno.PXBS as btm_x_shear,
    refno.PYBS as btm_y_shear,
    refno.PDIA as diameter,
    refno.PHEI as height,
    refno.PAXI as axis,
    refno.PDIS as dist_to_btm
FROM (
    SELECT VALUE in FROM pe:⟨24381_46958⟩<-pe_owner WHERE in.noun = 'SSLC'
)
ORDER BY refno;
```

### 查询 3: 检查第一个 SSLC 的完整属性

```sql
-- 查询第一个 SSLC 的所有属性
SELECT * FROM (
    SELECT VALUE in FROM pe:⟨24381_46958⟩<-pe_owner WHERE in.noun = 'SSLC' LIMIT 1
)[0].refno;
```

### 查询 4: 检查 BEND 的层级结构

```sql
-- 检查 BEND 是否有孙子节点
SELECT
    'level_1' as level,
    id,
    refno,
    noun,
    name
FROM (
    SELECT VALUE in FROM pe:⟨24381_46958⟩<-pe_owner
)
UNION ALL
SELECT
    'level_2' as level,
    id,
    refno,
    noun,
    name
FROM (
    SELECT VALUE in FROM array::flatten(
        (SELECT VALUE in FROM pe:⟨24381_46958⟩<-pe_owner)<-pe_owner
    )
)
ORDER BY level, noun, refno;
```

## 预期结果分析

### 正常情况

如果 BEND 的几何体数据正常，应该看到：
1. 多个 SSLC 子元素（通常 5-10 个，取决于弯头的分段数）
2. 每个 SSLC 都有不同的 shear angles（PXTS, PYTS, PXBS, PYBS）
3. 每个 SSLC 都有正确的 diameter (PDIA) 和 height (PHEI)
4. 每个 SSLC 都有正确的 axis (PAXI) 和 dist_to_btm (PDIS)

### 异常情况

如果看到以下情况，说明数据有问题：
1. **没有 SSLC 子元素** - 可能 noun 类型不对，或者数据缺失
2. **SSLC 属性为 NULL** - 属性数据缺失，需要重新导入
3. **所有 SSLC 的 shear angles 都是 0** - 数据错误或计算错误
4. **SSLC 在第 2 层** - 查询深度不够，需要调整查询范围

