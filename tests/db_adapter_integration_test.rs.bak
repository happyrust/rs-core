use aios_core::db_adapter::{
    DatabaseAdapter, HybridConfig, HybridDatabaseManager, HybridMode, QueryContext,
    SurrealAdapter,
};
use aios_core::types::{RefnoEnum, RefU64};
use std::sync::Arc;

#[cfg(feature = "kuzu")]
use aios_core::db_adapter::KuzuAdapter;
#[cfg(feature = "kuzu")]
use aios_core::rs_kuzu::{init_kuzu, init_kuzu_schema};
#[cfg(feature = "kuzu")]
use kuzu::SystemConfig;

#[tokio::test]
async fn test_surreal_adapter_full_workflow() {
    let adapter = SurrealAdapter::new("integration_surreal".to_string());

    let health = adapter.health_check().await;
    assert!(health.is_ok() && health.unwrap());

    let ctx = QueryContext::default();
    let refno = RefnoEnum::from(RefU64::from(1u64));

    let pe_result = adapter.get_pe(refno, ctx.clone()).await;
    assert!(pe_result.is_ok());

    let children_result = adapter.query_children(refno, ctx.clone()).await;
    assert!(children_result.is_ok());

    let attmap_result = adapter.get_attmap(refno, ctx).await;
    assert!(attmap_result.is_ok());

    println!("✓ SurrealAdapter full workflow test passed");
}

#[cfg(feature = "kuzu")]
#[tokio::test]
async fn test_kuzu_adapter_full_workflow() {
    let config = SystemConfig::default();
    init_kuzu("integration_test_kuzu.db", config)
        .await
        .expect("Failed to initialize Kuzu");
    init_kuzu_schema()
        .await
        .expect("Failed to initialize schema");

    let adapter = KuzuAdapter::new("integration_kuzu".to_string());

    let health = adapter.health_check().await;
    assert!(health.is_ok() && health.unwrap());

    let ctx = QueryContext::default();
    let refno = RefnoEnum::from(RefU64::from(1u64));

    let pe_result = adapter.get_pe(refno, ctx.clone()).await;
    assert!(pe_result.is_ok());

    let children_result = adapter.query_children(refno, ctx.clone()).await;
    assert!(children_result.is_ok());

    let attmap_result = adapter.get_attmap(refno, ctx.clone()).await;
    assert!(attmap_result.is_ok());

    let graph_ctx = QueryContext {
        requires_graph_traversal: true,
        ..Default::default()
    };

    let from = RefnoEnum::from(RefU64::from(1u64));
    let to = RefnoEnum::from(RefU64::from(10u64));
    let path_result = adapter.shortest_path(from, to, graph_ctx).await;
    assert!(path_result.is_ok());

    println!("✓ KuzuAdapter full workflow test passed");
}

#[tokio::test]
async fn test_hybrid_manager_surreal_only() {
    let surreal = Arc::new(SurrealAdapter::new("hybrid_surreal".to_string()));
    let config = HybridConfig {
        mode: HybridMode::SurrealPrimary,
        query_timeout_ms: 5000,
        fallback_on_error: true,
        enable_cache: false,
        cache_ttl_secs: 300,
    };

    let manager = HybridDatabaseManager::new(surreal, None, config, "integration_hybrid".to_string());

    let health = manager.health_check().await;
    assert!(health.is_ok() && health.unwrap());

    let ctx = QueryContext::default();
    let refno = RefnoEnum::from(RefU64::from(1u64));

    let pe_result = manager.get_pe(refno, ctx.clone()).await;
    assert!(pe_result.is_ok());

    let children_result = manager.query_children(refno, ctx.clone()).await;
    assert!(children_result.is_ok());

    let attmap_result = manager.get_attmap(refno, ctx).await;
    assert!(attmap_result.is_ok());

    println!("✓ HybridDatabaseManager (Surreal only) full workflow test passed");
}

#[cfg(feature = "kuzu")]
#[tokio::test]
async fn test_hybrid_manager_dual_database() {
    let kuzu_config = SystemConfig::default();
    init_kuzu("integration_dual_kuzu.db", kuzu_config)
        .await
        .expect("Failed to initialize Kuzu");
    init_kuzu_schema()
        .await
        .expect("Failed to initialize schema");

    let surreal = Arc::new(SurrealAdapter::new("dual_surreal".to_string()));
    let kuzu = Arc::new(KuzuAdapter::new("dual_kuzu".to_string()));

    let config = HybridConfig {
        mode: HybridMode::DualKuzuPreferred,
        query_timeout_ms: 5000,
        fallback_on_error: true,
        enable_cache: false,
        cache_ttl_secs: 300,
    };

    let manager = HybridDatabaseManager::new(
        surreal,
        Some(kuzu),
        config,
        "integration_dual".to_string(),
    );

    let health = manager.health_check().await;
    assert!(health.is_ok() && health.unwrap());

    let ctx = QueryContext::default();
    let refno = RefnoEnum::from(RefU64::from(1u64));

    let pe_result = manager.get_pe(refno, ctx.clone()).await;
    assert!(pe_result.is_ok());

    let graph_ctx = QueryContext {
        requires_graph_traversal: true,
        ..Default::default()
    };

    let from = RefnoEnum::from(RefU64::from(1u64));
    let to = RefnoEnum::from(RefU64::from(10u64));
    let path_result = manager.shortest_path(from, to, graph_ctx.clone()).await;
    assert!(path_result.is_ok());

    let subtree_result = manager.query_subtree(refno, Some(3), graph_ctx).await;
    assert!(subtree_result.is_ok());

    println!("✓ HybridDatabaseManager (Dual database) full workflow test passed");
}

#[cfg(feature = "kuzu")]
#[tokio::test]
async fn test_all_hybrid_modes() {
    let kuzu_config = SystemConfig::default();
    init_kuzu("integration_modes_kuzu.db", kuzu_config)
        .await
        .expect("Failed to initialize Kuzu");
    init_kuzu_schema()
        .await
        .expect("Failed to initialize schema");

    let surreal = Arc::new(SurrealAdapter::new("modes_surreal".to_string()));
    let kuzu = Arc::new(KuzuAdapter::new("modes_kuzu".to_string()));

    let modes = vec![
        HybridMode::SurrealPrimary,
        HybridMode::KuzuPrimary,
        HybridMode::DualSurrealPreferred,
        HybridMode::DualKuzuPreferred,
        HybridMode::WriteToSurrealReadFromKuzu,
    ];

    for mode in modes {
        let config = HybridConfig {
            mode: mode.clone(),
            query_timeout_ms: 5000,
            fallback_on_error: true,
            enable_cache: false,
            cache_ttl_secs: 300,
        };

        let manager = HybridDatabaseManager::new(
            surreal.clone(),
            Some(kuzu.clone()),
            config,
            format!("mode_test_{:?}", mode),
        );

        let health = manager.health_check().await;
        assert!(health.is_ok() && health.unwrap(), "Mode {:?} health check failed", mode);

        let ctx = QueryContext::default();
        let refno = RefnoEnum::from(RefU64::from(1u64));

        let result = manager.get_pe(refno, ctx).await;
        assert!(result.is_ok(), "Mode {:?} get_pe failed", mode);

        println!("✓ Mode {:?} test passed", mode);
    }

    println!("✓ All hybrid modes test passed");
}